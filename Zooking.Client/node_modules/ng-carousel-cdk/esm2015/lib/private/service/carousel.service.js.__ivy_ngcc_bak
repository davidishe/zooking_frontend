import { AnimationBuilder } from '@angular/animations';
import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { CarouselState } from '../models/carousel-state';
import { IdGenerator } from '../models/id-generator';
import { procedurePipe } from '../models/procedure/procedure-pipe';
import { SLIDE_ID_GENERATOR } from '../tokens';
import { disableAutoplayProcedure } from './helpers/disable-autoplay/disable-autoplay-procedure';
import { enableAutoplayProcedure } from './helpers/enable-autoplay/enable-autoplay-procedure';
import { cleanupProcedure } from './procedures/cleanup-procedure';
import { dragEndProcedure } from './procedures/drag-end-procedure';
import { dragProcedure } from './procedures/drag-procedure';
import { dragStartProcedure } from './procedures/drag-start-procedure';
import { goToProcedure } from './procedures/go-to-procedure';
import { initializeConfigProcedure } from './procedures/initialize-config-procedure';
import { initializeContainersProcedure } from './procedures/initialize-containers-procedure';
import { nextProcedure } from './procedures/next-procedure';
import { prevProcedure } from './procedures/prev-procedure';
import { recalculateProcedure } from './procedures/recalculate-procedure';
import { ANIMATION_BEZIER_ARGS } from './procedures/set-beziers/set-beziers-procedure';
import { setTemplateProcedure } from './procedures/set-template/set-template-procedure';
/**
 * Short swipe might not change slide to next/prev.
 * This const specifies how much (% of viewport) swipe
 * should overcome to trigger next/prev slide change.
 */
const MAX_SWIPE_THRESHOLD = 15;
/**
 * How much % user can stretch carousel, when there's no more
 * drag available
 */
const MAX_OVERSCROLL = 10;
export class CarouselService {
    constructor(animationBuilder, slideIdGenerator, 
    // tslint:disable-next-line: ban-types
    platformId) {
        this.animationBuilder = animationBuilder;
        this.slideIdGenerator = slideIdGenerator;
        this.platformId = platformId;
        this.carouselState$ = new BehaviorSubject(new CarouselState());
        /** Describes constant entities for procedures */
        this.procedureEnvironment = {
            slideIdGenerator: this.slideIdGenerator,
            isBrowser: isPlatformBrowser(this.platformId),
            autoplayAction: this.next.bind(this),
            afterAnimationAction: this.cleanup.bind(this),
            animationBuilder: this.animationBuilder,
            animationBezierArgs: ANIMATION_BEZIER_ARGS,
            swipeThreshold: MAX_SWIPE_THRESHOLD,
            maxOverscroll: MAX_OVERSCROLL,
        };
    }
    ngOnDestroy() {
        var _a, _b, _c;
        (_c = (_b = (_a = this.carouselState$.getValue()) === null || _a === void 0 ? void 0 : _a.autoplay) === null || _b === void 0 ? void 0 : _b.autoplaySubscription) === null || _c === void 0 ? void 0 : _c.unsubscribe();
    }
    carouselStateChanges() {
        return this.carouselState$.asObservable();
    }
    setItemIndex(newItemIndex) {
        this.apply(goToProcedure(newItemIndex));
    }
    prev() {
        this.apply(prevProcedure());
    }
    /**
     * @param omitAutoplayReset whether autoplay timer should not be resetted
     */
    next(omitAutoplayReset = false) {
        this.apply(nextProcedure(omitAutoplayReset));
    }
    recalculate() {
        this.apply(recalculateProcedure());
    }
    /** Update state to announce that drag sequence just started */
    dragStart() {
        this.apply(dragStartProcedure());
    }
    /**
     * Update state to announce that drag sequence just ended
     * and perform necessary cleanups
     */
    dragEnd(passedDistance) {
        this.apply(dragEndProcedure(passedDistance));
    }
    /** Process single drag tick with given from and to coordinates */
    drag(fromX, toX) {
        this.apply(dragProcedure(fromX, toX));
    }
    setSlideTemplate(newTemplateRef) {
        this.apply(setTemplateProcedure(newTemplateRef));
    }
    disableAutoplay(suspender) {
        this.apply(disableAutoplayProcedure(suspender));
    }
    /**
     * Starts new autoplay timer
     */
    enableAutoplay(suspender = null) {
        this.apply(enableAutoplayProcedure(suspender));
    }
    setContainers(widthContainer, animatableContainer) {
        this.apply(initializeContainersProcedure(widthContainer, animatableContainer));
    }
    setConfig(newConfig) {
        this.apply(initializeConfigProcedure(newConfig));
    }
    cleanup() {
        this.apply(cleanupProcedure());
    }
    /**
     * Applies specified procedure to carousel state
     */
    apply(procedure) {
        const state = Object.assign({}, this.carouselState$.getValue());
        const result = procedurePipe('applier', procedure)({ state, procedureState: {}, environment: this.procedureEnvironment });
        this.carouselState$.next(result.state);
    }
}
CarouselService.decorators = [
    { type: Injectable }
];
CarouselService.ctorParameters = () => [
    { type: AnimationBuilder },
    { type: IdGenerator, decorators: [{ type: Inject, args: [SLIDE_ID_GENERATOR,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2Fyb3VzZWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWNhcm91c2VsL3NyYy9saWIvcHJpdmF0ZS9zZXJ2aWNlL2Nhcm91c2VsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQWEsV0FBVyxFQUFlLE1BQU0sZUFBZSxDQUFDO0FBQ3hGLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFJbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUVyRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFbkUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQy9DLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHVEQUF1RCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHFEQUFxRCxDQUFDO0FBQzlGLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN2RSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDN0QsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFD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QkFBOUMsTUFBTSxTQUFDLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbmltYXRpb25CdWlsZGVyIH0gZnJvbSAnQGFuZ3VsYXIvYW5pbWF0aW9ucyc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9uRGVzdHJveSwgUExBVEZPUk1fSUQsIFRlbXBsYXRlUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgQ2Fyb3VzZWxDb25maWcgfSBmcm9tICcuLi8uLi9jYXJvdXNlbC1jb25maWcnO1xuaW1wb3J0IHsgQXV0b3BsYXlTdXNwZW5kZXIgfSBmcm9tICcuLi9tb2RlbHMvYXV0b3BsYXktc3VzcGVuZGVyJztcbmltcG9ydCB7IENhcm91c2VsU3RhdGUgfSBmcm9tICcuLi9tb2RlbHMvY2Fyb3VzZWwtc3RhdGUnO1xuaW1wb3J0IHsgSWRHZW5lcmF0b3IgfSBmcm9tICcuLi9tb2RlbHMvaWQtZ2VuZXJhdG9yJztcbmltcG9ydCB7IFByb2NlZHVyZUVudmlyb25tZW50IH0gZnJvbSAnLi4vbW9kZWxzL3Byb2NlZHVyZS9wcm9jZWR1cmUtZW52aXJvbm1lbnQuaW50ZXJmYWNlJztcbmltcG9ydCB7IHByb2NlZHVyZVBpcGUgfSBmcm9tICcuLi9tb2RlbHMvcHJvY2VkdXJlL3Byb2NlZHVyZS1waXBlJztcbmltcG9ydCB7IFByb2NlZHVyZSB9IGZyb20gJy4uL21vZGVscy9wcm9jZWR1cmUvcHJvY2VkdXJlLnR5cGUnO1xuaW1wb3J0IHsgU0xJREVfSURfR0VORVJBVE9SIH0gZnJvbSAnLi4vdG9rZW5zJztcbmltcG9ydCB7IGRpc2FibGVBdXRvcGxheVByb2NlZHVyZSB9IGZyb20gJy4vaGVscGVycy9kaXNhYmxlLWF1dG9wbGF5L2Rpc2FibGUtYXV0b3BsYXktcHJvY2VkdXJlJztcbmltcG9ydCB7IGVuYWJsZUF1dG9wbGF5UHJvY2VkdXJlIH0gZnJvbSAnLi9oZWxwZXJzL2VuYWJsZS1hdXRvcGxheS9lbmFibGUtYXV0b3BsYXktcHJvY2VkdXJlJztcbmltcG9ydCB7IGNsZWFudXBQcm9jZWR1cmUgfSBmcm9tICcuL3Byb2NlZHVyZXMvY2xlYW51cC1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgZHJhZ0VuZFByb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9kcmFnLWVuZC1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgZHJhZ1Byb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9kcmFnLXByb2NlZHVyZSc7XG5pbXBvcnQgeyBkcmFnU3RhcnRQcm9jZWR1cmUgfSBmcm9tICcuL3Byb2NlZHVyZXMvZHJhZy1zdGFydC1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgZ29Ub1Byb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9nby10by1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZUNvbmZpZ1Byb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9pbml0aWFsaXplLWNvbmZpZy1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgaW5pdGlhbGl6ZUNvbnRhaW5lcnNQcm9jZWR1cmUgfSBmcm9tICcuL3Byb2NlZHVyZXMvaW5pdGlhbGl6ZS1jb250YWluZXJzLXByb2NlZHVyZSc7XG5pbXBvcnQgeyBuZXh0UHJvY2VkdXJlIH0gZnJvbSAnLi9wcm9jZWR1cmVzL25leHQtcHJvY2VkdXJlJztcbmltcG9ydCB7IHByZXZQcm9jZWR1cmUgfSBmcm9tICcuL3Byb2NlZHVyZXMvcHJldi1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgcmVjYWxjdWxhdGVQcm9jZWR1cmUgfSBmcm9tICcuL3Byb2NlZHVyZXMvcmVjYWxjdWxhdGUtcHJvY2VkdXJlJztcbmltcG9ydCB7IEFOSU1BVElPTl9CRVpJRVJfQVJHUyB9IGZyb20gJy4vcHJvY2VkdXJlcy9zZXQtYmV6aWVycy9zZXQtYmV6aWVycy1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgc2V0VGVtcGxhdGVQcm9jZWR1cmUgfSBmcm9tICcuL3Byb2NlZHVyZXMvc2V0LXRlbXBsYXRlL3NldC10ZW1wbGF0ZS1wcm9jZWR1cmUnO1xuXG4vKipcbiAqIFNob3J0IHN3aXBlIG1pZ2h0IG5vdCBjaGFuZ2Ugc2xpZGUgdG8gbmV4dC9wcmV2LlxuICogVGhpcyBjb25zdCBzcGVjaWZpZXMgaG93IG11Y2ggKCUgb2Ygdmlld3BvcnQpIHN3aXBlXG4gKiBzaG91bGQgb3ZlcmNvbWUgdG8gdHJpZ2dlciBuZXh0L3ByZXYgc2xpZGUgY2hhbmdlLlxuICovXG5jb25zdCBNQVhfU1dJUEVfVEhSRVNIT0xEID0gMTU7XG4vKipcbiAqIEhvdyBtdWNoICUgdXNlciBjYW4gc3RyZXRjaCBjYXJvdXNlbCwgd2hlbiB0aGVyZSdzIG5vIG1vcmVcbiAqIGRyYWcgYXZhaWxhYmxlXG4gKi9cbmNvbnN0IE1BWF9PVkVSU0NST0xMID0gMTA7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDYXJvdXNlbFNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuXG4gICAgcHJpdmF0ZSByZWFkb25seSBjYXJvdXNlbFN0YXRlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q2Fyb3VzZWxTdGF0ZT4obmV3IENhcm91c2VsU3RhdGUoKSk7XG4gICAgLyoqIERlc2NyaWJlcyBjb25zdGFudCBlbnRpdGllcyBmb3IgcHJvY2VkdXJlcyAqL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcHJvY2VkdXJlRW52aXJvbm1lbnQ6IFByb2NlZHVyZUVudmlyb25tZW50ID0ge1xuICAgICAgICBzbGlkZUlkR2VuZXJhdG9yOiB0aGlzLnNsaWRlSWRHZW5lcmF0b3IsXG4gICAgICAgIGlzQnJvd3NlcjogaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSxcbiAgICAgICAgYXV0b3BsYXlBY3Rpb246IHRoaXMubmV4dC5iaW5kKHRoaXMpLFxuICAgICAgICBhZnRlckFuaW1hdGlvbkFjdGlvbjogdGhpcy5jbGVhbnVwLmJpbmQodGhpcyksXG4gICAgICAgIGFuaW1hdGlvbkJ1aWxkZXI6IHRoaXMuYW5pbWF0aW9uQnVpbGRlcixcbiAgICAgICAgYW5pbWF0aW9uQmV6aWVyQXJnczogQU5JTUFUSU9OX0JFWklFUl9BUkdTLFxuICAgICAgICBzd2lwZVRocmVzaG9sZDogTUFYX1NXSVBFX1RIUkVTSE9MRCxcbiAgICAgICAgbWF4T3ZlcnNjcm9sbDogTUFYX09WRVJTQ1JPTEwsXG4gICAgfTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGFuaW1hdGlvbkJ1aWxkZXI6IEFuaW1hdGlvbkJ1aWxkZXIsXG4gICAgICAgIEBJbmplY3QoU0xJREVfSURfR0VORVJBVE9SKSBwcml2YXRlIHNsaWRlSWRHZW5lcmF0b3I6IElkR2VuZXJhdG9yLFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGJhbi10eXBlc1xuICAgICAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IE9iamVjdCxcbiAgICApIHtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jYXJvdXNlbFN0YXRlJC5nZXRWYWx1ZSgpPy5hdXRvcGxheT8uYXV0b3BsYXlTdWJzY3JpcHRpb24/LnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgY2Fyb3VzZWxTdGF0ZUNoYW5nZXMoKTogT2JzZXJ2YWJsZTxDYXJvdXNlbFN0YXRlPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhcm91c2VsU3RhdGUkLmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIHNldEl0ZW1JbmRleChuZXdJdGVtSW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KGdvVG9Qcm9jZWR1cmUobmV3SXRlbUluZGV4KSk7XG4gICAgfVxuXG4gICAgcHJldigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShwcmV2UHJvY2VkdXJlKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBvbWl0QXV0b3BsYXlSZXNldCB3aGV0aGVyIGF1dG9wbGF5IHRpbWVyIHNob3VsZCBub3QgYmUgcmVzZXR0ZWRcbiAgICAgKi9cbiAgICBuZXh0KG9taXRBdXRvcGxheVJlc2V0ID0gZmFsc2UpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShuZXh0UHJvY2VkdXJlKG9taXRBdXRvcGxheVJlc2V0KSk7XG4gICAgfVxuXG4gICAgcmVjYWxjdWxhdGUoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkocmVjYWxjdWxhdGVQcm9jZWR1cmUoKSk7XG4gICAgfVxuXG4gICAgLyoqIFVwZGF0ZSBzdGF0ZSB0byBhbm5vdW5jZSB0aGF0IGRyYWcgc2VxdWVuY2UganVzdCBzdGFydGVkICovXG4gICAgZHJhZ1N0YXJ0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KGRyYWdTdGFydFByb2NlZHVyZSgpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgc3RhdGUgdG8gYW5ub3VuY2UgdGhhdCBkcmFnIHNlcXVlbmNlIGp1c3QgZW5kZWRcbiAgICAgKiBhbmQgcGVyZm9ybSBuZWNlc3NhcnkgY2xlYW51cHNcbiAgICAgKi9cbiAgICBkcmFnRW5kKHBhc3NlZERpc3RhbmNlOiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShkcmFnRW5kUHJvY2VkdXJlKHBhc3NlZERpc3RhbmNlKSk7XG4gICAgfVxuXG4gICAgLyoqIFByb2Nlc3Mgc2luZ2xlIGRyYWcgdGljayB3aXRoIGdpdmVuIGZyb20gYW5kIHRvIGNvb3JkaW5hdGVzICovXG4gICAgZHJhZyhmcm9tWDogbnVtYmVyLCB0b1g6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KGRyYWdQcm9jZWR1cmUoZnJvbVgsIHRvWCkpO1xuICAgIH1cblxuICAgIHNldFNsaWRlVGVtcGxhdGUobmV3VGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPGFueT4gfCBudWxsKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkoc2V0VGVtcGxhdGVQcm9jZWR1cmUobmV3VGVtcGxhdGVSZWYpKTtcbiAgICB9XG5cbiAgICBkaXNhYmxlQXV0b3BsYXkoc3VzcGVuZGVyOiBBdXRvcGxheVN1c3BlbmRlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KGRpc2FibGVBdXRvcGxheVByb2NlZHVyZShzdXNwZW5kZXIpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydHMgbmV3IGF1dG9wbGF5IHRpbWVyXG4gICAgICovXG4gICAgZW5hYmxlQXV0b3BsYXkoc3VzcGVuZGVyOiBBdXRvcGxheVN1c3BlbmRlciA9IG51bGwpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShlbmFibGVBdXRvcGxheVByb2NlZHVyZShzdXNwZW5kZXIpKTtcbiAgICB9XG5cbiAgICBzZXRDb250YWluZXJzKHdpZHRoQ29udGFpbmVyOiBIVE1MRWxlbWVudCwgYW5pbWF0YWJsZUNvbnRhaW5lcjogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShpbml0aWFsaXplQ29udGFpbmVyc1Byb2NlZHVyZSh3aWR0aENvbnRhaW5lciwgYW5pbWF0YWJsZUNvbnRhaW5lcikpO1xuICAgIH1cblxuICAgIHNldENvbmZpZyhuZXdDb25maWc6IENhcm91c2VsQ29uZmlnKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkoaW5pdGlhbGl6ZUNvbmZpZ1Byb2NlZHVyZShuZXdDb25maWcpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNsZWFudXAoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkoY2xlYW51cFByb2NlZHVyZSgpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBcHBsaWVzIHNwZWNpZmllZCBwcm9jZWR1cmUgdG8gY2Fyb3VzZWwgc3RhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIGFwcGx5KHByb2NlZHVyZTogUHJvY2VkdXJlKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHN0YXRlOiBDYXJvdXNlbFN0YXRlID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5jYXJvdXNlbFN0YXRlJC5nZXRWYWx1ZSgpKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcHJvY2VkdXJlUGlwZSgnYXBwbGllcicsIHByb2NlZHVyZSkoe3N0YXRlLCBwcm9jZWR1cmVTdGF0ZToge30sIGVudmlyb25tZW50OiB0aGlzLnByb2NlZHVyZUVudmlyb25tZW50fSk7XG4gICAgICAgIHRoaXMuY2Fyb3VzZWxTdGF0ZSQubmV4dChyZXN1bHQuc3RhdGUpO1xuICAgIH1cbn1cbiJdfQ==