import { AnimationBuilder } from '@angular/animations';
import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { CarouselState } from '../models/carousel-state';
import { IdGenerator } from '../models/id-generator';
import { procedurePipe } from '../models/procedure/procedure-pipe';
import { SLIDE_ID_GENERATOR } from '../tokens';
import { disableAutoplayProcedure } from './helpers/disable-autoplay/disable-autoplay-procedure';
import { enableAutoplayProcedure } from './helpers/enable-autoplay/enable-autoplay-procedure';
import { cleanupProcedure } from './procedures/cleanup-procedure';
import { dragEndProcedure } from './procedures/drag-end-procedure';
import { dragProcedure } from './procedures/drag-procedure';
import { dragStartProcedure } from './procedures/drag-start-procedure';
import { goToProcedure } from './procedures/go-to-procedure';
import { initializeConfigProcedure } from './procedures/initialize-config-procedure';
import { initializeContainersProcedure } from './procedures/initialize-containers-procedure';
import { nextProcedure } from './procedures/next-procedure';
import { prevProcedure } from './procedures/prev-procedure';
import { recalculateProcedure } from './procedures/recalculate-procedure';
import { ANIMATION_BEZIER_ARGS } from './procedures/set-beziers/set-beziers-procedure';
import { setTemplateProcedure } from './procedures/set-template/set-template-procedure';
/**
 * Short swipe might not change slide to next/prev.
 * This const specifies how much (% of viewport) swipe
 * should overcome to trigger next/prev slide change.
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/animations';
import * as ɵngcc2 from '../models/id-generator';
const MAX_SWIPE_THRESHOLD = 15;
/**
 * How much % user can stretch carousel, when there's no more
 * drag available
 */
const MAX_OVERSCROLL = 10;
export class CarouselService {
    constructor(animationBuilder, slideIdGenerator, 
    // tslint:disable-next-line: ban-types
    platformId) {
        this.animationBuilder = animationBuilder;
        this.slideIdGenerator = slideIdGenerator;
        this.platformId = platformId;
        this.carouselState$ = new BehaviorSubject(new CarouselState());
        /** Describes constant entities for procedures */
        this.procedureEnvironment = {
            slideIdGenerator: this.slideIdGenerator,
            isBrowser: isPlatformBrowser(this.platformId),
            autoplayAction: this.next.bind(this),
            afterAnimationAction: this.cleanup.bind(this),
            animationBuilder: this.animationBuilder,
            animationBezierArgs: ANIMATION_BEZIER_ARGS,
            swipeThreshold: MAX_SWIPE_THRESHOLD,
            maxOverscroll: MAX_OVERSCROLL,
        };
    }
    ngOnDestroy() {
        var _a, _b, _c;
        (_c = (_b = (_a = this.carouselState$.getValue()) === null || _a === void 0 ? void 0 : _a.autoplay) === null || _b === void 0 ? void 0 : _b.autoplaySubscription) === null || _c === void 0 ? void 0 : _c.unsubscribe();
    }
    carouselStateChanges() {
        return this.carouselState$.asObservable();
    }
    setItemIndex(newItemIndex) {
        this.apply(goToProcedure(newItemIndex));
    }
    prev() {
        this.apply(prevProcedure());
    }
    /**
     * @param omitAutoplayReset whether autoplay timer should not be resetted
     */
    next(omitAutoplayReset = false) {
        this.apply(nextProcedure(omitAutoplayReset));
    }
    recalculate() {
        this.apply(recalculateProcedure());
    }
    /** Update state to announce that drag sequence just started */
    dragStart() {
        this.apply(dragStartProcedure());
    }
    /**
     * Update state to announce that drag sequence just ended
     * and perform necessary cleanups
     */
    dragEnd(passedDistance) {
        this.apply(dragEndProcedure(passedDistance));
    }
    /** Process single drag tick with given from and to coordinates */
    drag(fromX, toX) {
        this.apply(dragProcedure(fromX, toX));
    }
    setSlideTemplate(newTemplateRef) {
        this.apply(setTemplateProcedure(newTemplateRef));
    }
    disableAutoplay(suspender) {
        this.apply(disableAutoplayProcedure(suspender));
    }
    /**
     * Starts new autoplay timer
     */
    enableAutoplay(suspender = null) {
        this.apply(enableAutoplayProcedure(suspender));
    }
    setContainers(widthContainer, animatableContainer) {
        this.apply(initializeContainersProcedure(widthContainer, animatableContainer));
    }
    setConfig(newConfig) {
        this.apply(initializeConfigProcedure(newConfig));
    }
    cleanup() {
        this.apply(cleanupProcedure());
    }
    /**
     * Applies specified procedure to carousel state
     */
    apply(procedure) {
        const state = Object.assign({}, this.carouselState$.getValue());
        const result = procedurePipe('applier', procedure)({ state, procedureState: {}, environment: this.procedureEnvironment });
        this.carouselState$.next(result.state);
    }
}
CarouselService.ɵfac = function CarouselService_Factory(t) { return new (t || CarouselService)(ɵngcc0.ɵɵinject(ɵngcc1.AnimationBuilder), ɵngcc0.ɵɵinject(SLIDE_ID_GENERATOR), ɵngcc0.ɵɵinject(PLATFORM_ID)); };
CarouselService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: CarouselService, factory: CarouselService.ɵfac });
CarouselService.ctorParameters = () => [
    { type: AnimationBuilder },
    { type: IdGenerator, decorators: [{ type: Inject, args: [SLIDE_ID_GENERATOR,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(CarouselService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.AnimationBuilder }, { type: ɵngcc2.IdGenerator, decorators: [{
                type: Inject,
                args: [SLIDE_ID_GENERATOR]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2Fyb3VzZWwuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctY2Fyb3VzZWwvc3JjL2xpYi9wcml2YXRlL3NlcnZpY2UvY2Fyb3VzZWwuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBYSxXQUFXLEVBQWUsTUFBTSxlQUFlLENBQUM7QUFDeEYsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUluRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDekQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXJELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUVuRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDL0MsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sdURBQXVELENBQUM7QUFDakcsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0scURBQXFELENBQUM7QUFDOUYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDbEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDbkUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUNyRixPQUFPLEVBQUUsNkJB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Q0wsSUFDSTtBQUNKO0FBQ0EsT0FBTztBQUNQLElBQVksS0FBSyxDQUFDLFNBQW9CO0FBQUksUUFDbEMsTUFBTSxLQUFLLEdBQWtCLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztBQUN2RixRQUFRLE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUMsRUFBQyxLQUFLLEVBQUUsY0FBYyxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixFQUFDLENBQUMsQ0FBQztBQUNoSSxRQUFRLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMvQyxJQUFJLENBQUM7QUFDTDsyQ0F4R0MsVUFBVTs2R0FDVDtBQUFDO0FBQXlDLFlBekNuQyxnQkFBZ0I7QUFBSSxZQVFwQixXQUFXLHVCQWtEWCxNQUFNLFNBQUMsa0JBQWtCO0FBQVMsWUFFTSxNQUFNLHVCQUE5QyxNQUFNLFNBQUMsV0FBVztBQUFROzs7Ozs7Ozs7a0NBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFuaW1hdGlvbkJ1aWxkZXIgfSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT25EZXN0cm95LCBQTEFURk9STV9JRCwgVGVtcGxhdGVSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBDYXJvdXNlbENvbmZpZyB9IGZyb20gJy4uLy4uL2Nhcm91c2VsLWNvbmZpZyc7XG5pbXBvcnQgeyBBdXRvcGxheVN1c3BlbmRlciB9IGZyb20gJy4uL21vZGVscy9hdXRvcGxheS1zdXNwZW5kZXInO1xuaW1wb3J0IHsgQ2Fyb3VzZWxTdGF0ZSB9IGZyb20gJy4uL21vZGVscy9jYXJvdXNlbC1zdGF0ZSc7XG5pbXBvcnQgeyBJZEdlbmVyYXRvciB9IGZyb20gJy4uL21vZGVscy9pZC1nZW5lcmF0b3InO1xuaW1wb3J0IHsgUHJvY2VkdXJlRW52aXJvbm1lbnQgfSBmcm9tICcuLi9tb2RlbHMvcHJvY2VkdXJlL3Byb2NlZHVyZS1lbnZpcm9ubWVudC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgcHJvY2VkdXJlUGlwZSB9IGZyb20gJy4uL21vZGVscy9wcm9jZWR1cmUvcHJvY2VkdXJlLXBpcGUnO1xuaW1wb3J0IHsgUHJvY2VkdXJlIH0gZnJvbSAnLi4vbW9kZWxzL3Byb2NlZHVyZS9wcm9jZWR1cmUudHlwZSc7XG5pbXBvcnQgeyBTTElERV9JRF9HRU5FUkFUT1IgfSBmcm9tICcuLi90b2tlbnMnO1xuaW1wb3J0IHsgZGlzYWJsZUF1dG9wbGF5UHJvY2VkdXJlIH0gZnJvbSAnLi9oZWxwZXJzL2Rpc2FibGUtYXV0b3BsYXkvZGlzYWJsZS1hdXRvcGxheS1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgZW5hYmxlQXV0b3BsYXlQcm9jZWR1cmUgfSBmcm9tICcuL2hlbHBlcnMvZW5hYmxlLWF1dG9wbGF5L2VuYWJsZS1hdXRvcGxheS1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgY2xlYW51cFByb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9jbGVhbnVwLXByb2NlZHVyZSc7XG5pbXBvcnQgeyBkcmFnRW5kUHJvY2VkdXJlIH0gZnJvbSAnLi9wcm9jZWR1cmVzL2RyYWctZW5kLXByb2NlZHVyZSc7XG5pbXBvcnQgeyBkcmFnUHJvY2VkdXJlIH0gZnJvbSAnLi9wcm9jZWR1cmVzL2RyYWctcHJvY2VkdXJlJztcbmltcG9ydCB7IGRyYWdTdGFydFByb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9kcmFnLXN0YXJ0LXByb2NlZHVyZSc7XG5pbXBvcnQgeyBnb1RvUHJvY2VkdXJlIH0gZnJvbSAnLi9wcm9jZWR1cmVzL2dvLXRvLXByb2NlZHVyZSc7XG5pbXBvcnQgeyBpbml0aWFsaXplQ29uZmlnUHJvY2VkdXJlIH0gZnJvbSAnLi9wcm9jZWR1cmVzL2luaXRpYWxpemUtY29uZmlnLXByb2NlZHVyZSc7XG5pbXBvcnQgeyBpbml0aWFsaXplQ29udGFpbmVyc1Byb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9pbml0aWFsaXplLWNvbnRhaW5lcnMtcHJvY2VkdXJlJztcbmltcG9ydCB7IG5leHRQcm9jZWR1cmUgfSBmcm9tICcuL3Byb2NlZHVyZXMvbmV4dC1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgcHJldlByb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9wcmV2LXByb2NlZHVyZSc7XG5pbXBvcnQgeyByZWNhbGN1bGF0ZVByb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9yZWNhbGN1bGF0ZS1wcm9jZWR1cmUnO1xuaW1wb3J0IHsgQU5JTUFUSU9OX0JFWklFUl9BUkdTIH0gZnJvbSAnLi9wcm9jZWR1cmVzL3NldC1iZXppZXJzL3NldC1iZXppZXJzLXByb2NlZHVyZSc7XG5pbXBvcnQgeyBzZXRUZW1wbGF0ZVByb2NlZHVyZSB9IGZyb20gJy4vcHJvY2VkdXJlcy9zZXQtdGVtcGxhdGUvc2V0LXRlbXBsYXRlLXByb2NlZHVyZSc7XG5cbi8qKlxuICogU2hvcnQgc3dpcGUgbWlnaHQgbm90IGNoYW5nZSBzbGlkZSB0byBuZXh0L3ByZXYuXG4gKiBUaGlzIGNvbnN0IHNwZWNpZmllcyBob3cgbXVjaCAoJSBvZiB2aWV3cG9ydCkgc3dpcGVcbiAqIHNob3VsZCBvdmVyY29tZSB0byB0cmlnZ2VyIG5leHQvcHJldiBzbGlkZSBjaGFuZ2UuXG4gKi9cbmNvbnN0IE1BWF9TV0lQRV9USFJFU0hPTEQgPSAxNTtcbi8qKlxuICogSG93IG11Y2ggJSB1c2VyIGNhbiBzdHJldGNoIGNhcm91c2VsLCB3aGVuIHRoZXJlJ3Mgbm8gbW9yZVxuICogZHJhZyBhdmFpbGFibGVcbiAqL1xuY29uc3QgTUFYX09WRVJTQ1JPTEwgPSAxMDtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENhcm91c2VsU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG5cbiAgICBwcml2YXRlIHJlYWRvbmx5IGNhcm91c2VsU3RhdGUkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDYXJvdXNlbFN0YXRlPihuZXcgQ2Fyb3VzZWxTdGF0ZSgpKTtcbiAgICAvKiogRGVzY3JpYmVzIGNvbnN0YW50IGVudGl0aWVzIGZvciBwcm9jZWR1cmVzICovXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9jZWR1cmVFbnZpcm9ubWVudDogUHJvY2VkdXJlRW52aXJvbm1lbnQgPSB7XG4gICAgICAgIHNsaWRlSWRHZW5lcmF0b3I6IHRoaXMuc2xpZGVJZEdlbmVyYXRvcixcbiAgICAgICAgaXNCcm93c2VyOiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpLFxuICAgICAgICBhdXRvcGxheUFjdGlvbjogdGhpcy5uZXh0LmJpbmQodGhpcyksXG4gICAgICAgIGFmdGVyQW5pbWF0aW9uQWN0aW9uOiB0aGlzLmNsZWFudXAuYmluZCh0aGlzKSxcbiAgICAgICAgYW5pbWF0aW9uQnVpbGRlcjogdGhpcy5hbmltYXRpb25CdWlsZGVyLFxuICAgICAgICBhbmltYXRpb25CZXppZXJBcmdzOiBBTklNQVRJT05fQkVaSUVSX0FSR1MsXG4gICAgICAgIHN3aXBlVGhyZXNob2xkOiBNQVhfU1dJUEVfVEhSRVNIT0xELFxuICAgICAgICBtYXhPdmVyc2Nyb2xsOiBNQVhfT1ZFUlNDUk9MTCxcbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgYW5pbWF0aW9uQnVpbGRlcjogQW5pbWF0aW9uQnVpbGRlcixcbiAgICAgICAgQEluamVjdChTTElERV9JRF9HRU5FUkFUT1IpIHByaXZhdGUgc2xpZGVJZEdlbmVyYXRvcjogSWRHZW5lcmF0b3IsXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzXG4gICAgICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogT2JqZWN0LFxuICAgICkge1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmNhcm91c2VsU3RhdGUkLmdldFZhbHVlKCk/LmF1dG9wbGF5Py5hdXRvcGxheVN1YnNjcmlwdGlvbj8udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBjYXJvdXNlbFN0YXRlQ2hhbmdlcygpOiBPYnNlcnZhYmxlPENhcm91c2VsU3RhdGU+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2Fyb3VzZWxTdGF0ZSQuYXNPYnNlcnZhYmxlKCk7XG4gICAgfVxuXG4gICAgc2V0SXRlbUluZGV4KG5ld0l0ZW1JbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkoZ29Ub1Byb2NlZHVyZShuZXdJdGVtSW5kZXgpKTtcbiAgICB9XG5cbiAgICBwcmV2KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KHByZXZQcm9jZWR1cmUoKSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIG9taXRBdXRvcGxheVJlc2V0IHdoZXRoZXIgYXV0b3BsYXkgdGltZXIgc2hvdWxkIG5vdCBiZSByZXNldHRlZFxuICAgICAqL1xuICAgIG5leHQob21pdEF1dG9wbGF5UmVzZXQgPSBmYWxzZSk6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KG5leHRQcm9jZWR1cmUob21pdEF1dG9wbGF5UmVzZXQpKTtcbiAgICB9XG5cbiAgICByZWNhbGN1bGF0ZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShyZWNhbGN1bGF0ZVByb2NlZHVyZSgpKTtcbiAgICB9XG5cbiAgICAvKiogVXBkYXRlIHN0YXRlIHRvIGFubm91bmNlIHRoYXQgZHJhZyBzZXF1ZW5jZSBqdXN0IHN0YXJ0ZWQgKi9cbiAgICBkcmFnU3RhcnQoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkoZHJhZ1N0YXJ0UHJvY2VkdXJlKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZSBzdGF0ZSB0byBhbm5vdW5jZSB0aGF0IGRyYWcgc2VxdWVuY2UganVzdCBlbmRlZFxuICAgICAqIGFuZCBwZXJmb3JtIG5lY2Vzc2FyeSBjbGVhbnVwc1xuICAgICAqL1xuICAgIGRyYWdFbmQocGFzc2VkRGlzdGFuY2U6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KGRyYWdFbmRQcm9jZWR1cmUocGFzc2VkRGlzdGFuY2UpKTtcbiAgICB9XG5cbiAgICAvKiogUHJvY2VzcyBzaW5nbGUgZHJhZyB0aWNrIHdpdGggZ2l2ZW4gZnJvbSBhbmQgdG8gY29vcmRpbmF0ZXMgKi9cbiAgICBkcmFnKGZyb21YOiBudW1iZXIsIHRvWDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkoZHJhZ1Byb2NlZHVyZShmcm9tWCwgdG9YKSk7XG4gICAgfVxuXG4gICAgc2V0U2xpZGVUZW1wbGF0ZShuZXdUZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PiB8IG51bGwpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShzZXRUZW1wbGF0ZVByb2NlZHVyZShuZXdUZW1wbGF0ZVJlZikpO1xuICAgIH1cblxuICAgIGRpc2FibGVBdXRvcGxheShzdXNwZW5kZXI6IEF1dG9wbGF5U3VzcGVuZGVyKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYXBwbHkoZGlzYWJsZUF1dG9wbGF5UHJvY2VkdXJlKHN1c3BlbmRlcikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0cyBuZXcgYXV0b3BsYXkgdGltZXJcbiAgICAgKi9cbiAgICBlbmFibGVBdXRvcGxheShzdXNwZW5kZXI6IEF1dG9wbGF5U3VzcGVuZGVyID0gbnVsbCk6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KGVuYWJsZUF1dG9wbGF5UHJvY2VkdXJlKHN1c3BlbmRlcikpO1xuICAgIH1cblxuICAgIHNldENvbnRhaW5lcnMod2lkdGhDb250YWluZXI6IEhUTUxFbGVtZW50LCBhbmltYXRhYmxlQ29udGFpbmVyOiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgICAgICB0aGlzLmFwcGx5KGluaXRpYWxpemVDb250YWluZXJzUHJvY2VkdXJlKHdpZHRoQ29udGFpbmVyLCBhbmltYXRhYmxlQ29udGFpbmVyKSk7XG4gICAgfVxuXG4gICAgc2V0Q29uZmlnKG5ld0NvbmZpZzogQ2Fyb3VzZWxDb25maWcpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShpbml0aWFsaXplQ29uZmlnUHJvY2VkdXJlKG5ld0NvbmZpZykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYW51cCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5hcHBseShjbGVhbnVwUHJvY2VkdXJlKCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFwcGxpZXMgc3BlY2lmaWVkIHByb2NlZHVyZSB0byBjYXJvdXNlbCBzdGF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgYXBwbHkocHJvY2VkdXJlOiBQcm9jZWR1cmUpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc3RhdGU6IENhcm91c2VsU3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmNhcm91c2VsU3RhdGUkLmdldFZhbHVlKCkpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBwcm9jZWR1cmVQaXBlKCdhcHBsaWVyJywgcHJvY2VkdXJlKSh7c3RhdGUsIHByb2NlZHVyZVN0YXRlOiB7fSwgZW52aXJvbm1lbnQ6IHRoaXMucHJvY2VkdXJlRW52aXJvbm1lbnR9KTtcbiAgICAgICAgdGhpcy5jYXJvdXNlbFN0YXRlJC5uZXh0KHJlc3VsdC5zdGF0ZSk7XG4gICAgfVxufVxuIl19