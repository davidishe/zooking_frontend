import { isPlatformBrowser } from '@angular/common';
import { ChangeDetectionStrategy, Component, ElementRef, Inject, PLATFORM_ID, Renderer2, ViewChild, ViewEncapsulation } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { distinctUntilChanged, filter, map, switchMapTo, takeUntil } from 'rxjs/operators';
import { CarouselSlideContext } from '../models/carousel-slide-context';
import { CarouselService } from '../service/carousel.service';
import { HammerProviderService } from '../service/hammer-provider.service';
/**
 * Contains listeners and other DOM controllers
 */
export class CarouselEngineComponent {
    constructor(carousel, elementRef, renderer, hammer, 
    // tslint:disable-next-line: ban-types
    platformId) {
        this.carousel = carousel;
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.hammer = hammer;
        this.platformId = platformId;
        this.transformValue$ = this.transformValueChanges();
        this.slideWidth$ = this.slideWidthChanges();
        this.template$ = this.templateChanges();
        this.slides$ = this.slidesChanges();
        this.focused = false;
        this.destroyed$ = new Subject();
    }
    get htmlElement() {
        return this.elementRef.nativeElement;
    }
    ngOnInit() {
        this.listenToAutoplay();
        this.listenToDragEvents();
        this.listenToResizeEvents();
        this.listenToKeyEvents();
        this.listenToScrollEvents();
        this.carousel.setContainers(this.htmlElement, this.galleryRef.nativeElement);
    }
    ngOnDestroy() {
        this.destroyMouseListeners();
        this.destroyHammer();
        this.destroyKeyboardListeners();
        this.destroyElementScrollListener();
        this.destroyed$.next();
        this.destroyed$.complete();
    }
    trackByFn(index, item) {
        return item.id;
    }
    contextOf(slide) {
        return new CarouselSlideContext(slide.options.item, slide.itemIndex, slide.options.isActive, slide.options.inViewport);
    }
    focusIn() {
        this.focused = true;
        this.carousel.disableAutoplay("focus" /* FOCUS */);
    }
    focusOut() {
        this.focused = false;
        this.carousel.enableAutoplay("focus" /* FOCUS */);
    }
    destroyMouseListeners() {
        if (this.mouseEnterDestructor) {
            this.mouseEnterDestructor();
        }
        if (this.mouseLeaveDestructor) {
            this.mouseLeaveDestructor();
        }
    }
    destroyHammer() {
        if (this.hammerManager) {
            this.hammerManager.destroy();
        }
    }
    destroyKeyboardListeners() {
        if (this.keyboardListener) {
            this.keyboardListener();
        }
    }
    destroyElementScrollListener() {
        if (this.containerScrollListener) {
            this.containerScrollListener();
        }
    }
    transformValueChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => `translateX(${state.offset}${state.config.widthMode})`));
    }
    slideWidthChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => `${state.config.slideWidth}${state.config.widthMode}`));
    }
    slidesChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => state.slides));
    }
    templateChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => state.template));
    }
    listenToAutoplay() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.carousel.carouselStateChanges()
            .pipe(map((state) => state.config.autoplayEnabled), distinctUntilChanged(), takeUntil(this.destroyed$))
            .subscribe((autoplayEnabled) => {
            if (this.mouseEnterDestructor) {
                this.mouseEnterDestructor();
            }
            if (this.mouseLeaveDestructor) {
                this.mouseLeaveDestructor();
            }
            if (!autoplayEnabled) {
                return;
            }
            this.mouseEnterDestructor = this.renderer.listen(this.htmlElement, 'mouseenter', () => this.carousel.disableAutoplay("mouse" /* MOUSE */));
            this.mouseLeaveDestructor = this.renderer.listen(this.htmlElement, 'mouseleave', () => this.carousel.enableAutoplay("mouse" /* MOUSE */));
        });
    }
    listenToDragEvents() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.carousel.carouselStateChanges()
            .pipe(map((state) => state.config.dragEnabled), distinctUntilChanged(), takeUntil(this.destroyed$))
            .subscribe((dragEnabled) => {
            if (this.hammerManager) {
                this.hammerManager.destroy();
            }
            if (!dragEnabled) {
                return;
            }
            this.hammerManager = this.hammer.managerFor(this.htmlElement);
            if (!this.hammerManager) {
                return;
            }
            let lastDelta = 0;
            let lastTouchAction;
            this.hammerManager.on('panstart', (event) => {
                // Checking whether pan started with horizontal gesture,
                // we should block all scroll attempts during current pan session then
                // tslint:disable-next-line: no-bitwise
                if (event.offsetDirection & Hammer.DIRECTION_HORIZONTAL) {
                    lastDelta = Math.round(event.deltaX);
                    this.carousel.dragStart();
                    lastTouchAction = this.htmlElement.style.touchAction;
                    this.renderer.setStyle(this.htmlElement, 'touch-action', 'none');
                }
            });
            this.hammerManager.on('panright panleft', (event) => {
                // We should not treat vertical pans as horizontal.
                // Be adviced that pan right/left events still counts
                // vertical pans as legitimate horizontal pan.
                // Next check clarifies that initial gesture was horizontal,
                // otherwise this variable would be falsy
                if (lastTouchAction) {
                    const x = Math.round(event.center.x);
                    const deltaX = Math.round(event.deltaX);
                    this.carousel.drag(x, x + (deltaX - lastDelta));
                    lastDelta = deltaX;
                }
            });
            this.hammerManager.on('panend pancancel', (event) => {
                if (lastTouchAction) {
                    this.carousel.dragEnd(event.deltaX);
                    this.renderer.setStyle(this.htmlElement, 'touch-action', lastTouchAction);
                    lastTouchAction = null;
                }
            });
        });
    }
    listenToResizeEvents() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.carousel.carouselStateChanges()
            .pipe(filter((state) => state.config.shouldRecalculateOnResize), switchMapTo(fromEvent(window, 'resize')), takeUntil(this.destroyed$))
            .subscribe(() => {
            this.carousel.recalculate();
        });
    }
    listenToKeyEvents() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.keyboardListener = this.renderer.listen(this.htmlElement, 'keydown', (event) => {
            const key = event.key.toLowerCase();
            if (['arrowright', 'right'].includes(key)) {
                this.carousel.next();
            }
            else if (['arrowleft', 'left'].includes(key)) {
                this.carousel.prev();
            }
        });
    }
    /**
     * Horizontal scroll might accidentaly happen on parent container
     * when pressing arrow buttons too fast. We should return
     * container to initial position when that happens.
     */
    listenToScrollEvents() {
        this.containerScrollListener = this.renderer.listen(this.htmlElement, 'scroll', () => {
            this.htmlElement.scrollTo(0, 0);
        });
    }
}
CarouselEngineComponent.decorators = [
    { type: Component, args: [{
                selector: 'carousel-engine',
                template: "<ul \n    #galleryRef\n    #focusTrapRef=\"cdkTrapFocus\"\n    [style.transform]=\"transformValue$ | async\"\n    [cdkTrapFocus]=\"false\"\n    (focusin)=\"focusIn()\"\n    (focusout)=\"focusOut()\"\n    class=\"ng-carousel-block\">\n    <li\n        *ngFor=\"let slide of (slides$ | async); trackBy: trackByFn;\"\n        [style.width]=\"slideWidth$ | async\"\n        [untabbable]=\"!slide.options.isActive\"\n        [untabbableFocusTrapRef]=\"focusTrapRef\"\n        [untabbableFocused]=\"focused\"\n        class=\"ng-carousel-slide\">\n        <ng-container *ngTemplateOutlet=\"(template$ | async); context: contextOf(slide);\"></ng-container>\n    </li>\n</ul>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                encapsulation: ViewEncapsulation.None,
                styles: [".ng-carousel-block{display:flex;margin:0;padding:0;width:100%;will-change:transform}.ng-carousel-slide{flex:none;list-style:none}"]
            },] }
];
CarouselEngineComponent.ctorParameters = () => [
    { type: CarouselService },
    { type: ElementRef },
    { type: Renderer2 },
    { type: HammerProviderService },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
CarouselEngineComponent.propDecorators = {
    galleryRef: [{ type: ViewChild, args: ['galleryRef', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2Fyb3VzZWwtZW5naW5lLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWNhcm91c2VsL3NyYy9saWIvcHJpdmF0ZS92aWV3cy9jYXJvdXNlbC1lbmdpbmUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBcUIsV0FBVyxFQUFFLFNBQVMsRUFBZSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0ssT0FBTyxFQUFFLFNBQVMsRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSTNGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRXhFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM5RCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQVMzRTs7R0FFRztBQUNILE1BQU0sT0FBTyx1QkFBdUI7SUFtQmhDLFlBQ1ksUUFBeUIsRUFDekIsVUFBc0IsRUFDdEIsUUFBbUIsRUFDbkIsTUFBNkI7SUFDckMsc0NBQXNDO0lBQ1QsVUFBa0I7UUFMdkMsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFDekIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLFdBQU0sR0FBTixNQUFNLENBQXVCO1FBRVIsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQXRCbkMsb0JBQWUsR0FBRyxJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztRQUMvQyxnQkFBVyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3ZDLGNBQVMsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDbkMsWUFBTyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN4QyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ04sZUFBVSxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFtQmxELENBQUM7SUFaRCxJQUFZLFdBQVc7UUFDbkIsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQztJQUN6QyxDQUFDO0lBWUQsUUFBUTtRQUNKLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNqRixDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztRQUNoQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUFhLEVBQUUsSUFBbUI7UUFDeEMsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFRCxTQUFTLENBQUMsS0FBb0I7UUFDMUIsT0FBTyxJQUFJLG9CQUFvQixDQUMzQixLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksRUFDbEIsS0FBSyxDQUFDLFNBQVMsRUFDZixLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFDdEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQzNCLENBQUM7SUFDTixDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxxQkFBeUIsQ0FBQztJQUMzRCxDQUFDO0lBRUQsUUFBUTtRQUNKLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxxQkFBeUIsQ0FBQztJQUMxRCxDQUFDO0lBRU8scUJBQXFCO1FBQ3pCLElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO1lBQzNCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1NBQy9CO1FBQ0QsSUFBSSxJQUFJLENBQUMsb0JBQW9CLEVBQUU7WUFDM0IsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7U0FDL0I7SUFDTCxDQUFDO0lBRU8sYUFBYTtRQUNqQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDcEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNoQztJQUNMLENBQUM7SUFFTyx3QkFBd0I7UUFDNUIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7U0FDM0I7SUFDTCxDQUFDO0lBRU8sNEJBQTRCO1FBQ2hDLElBQUksSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQzlCLElBQUksQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1NBQ2xDO0lBQ0wsQ0FBQztJQUVPLHFCQUFxQjtRQUN6QixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUU7YUFDdEMsSUFBSSxDQUNELEdBQUcsQ0FBQyxDQUFDLEtBQW9CLEVBQUUsRUFBRSxDQUFDLGNBQWMsS0FBSyxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQ3hGLENBQUM7SUFDVixDQUFDO0lBRU8saUJBQWlCO1FBQ3JCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRTthQUN0QyxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsS0FBb0IsRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQ3ZGLENBQUM7SUFDVixDQUFDO0lBRU8sYUFBYTtRQUNqQixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUU7YUFDdEMsSUFBSSxDQUNELEdBQUcsQ0FBQyxDQUFDLEtBQW9CLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FDOUMsQ0FBQztJQUNWLENBQUM7SUFFTyxlQUFlO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRTthQUN0QyxJQUFJLENBQ0QsR0FBRyxDQUFDLENBQUMsS0FBb0IsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUNoRCxDQUFDO0lBQ1YsQ0FBQztJQUVPLGdCQUFnQjtRQUNwQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBRXJDLE9BQU87U0FDVjtRQUNELElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUU7YUFDL0IsSUFBSSxDQUNELEdBQUcsQ0FBQyxDQUFDLEtBQW9CLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLEVBQzNELG9CQUFvQixFQUFFLEVBQ3RCLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQzdCO2FBQ0EsU0FBUyxDQUFDLENBQUMsZUFBd0IsRUFBRSxFQUFFO1lBQ3BDLElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO2dCQUMzQixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQzthQUMvQjtZQUNELElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO2dCQUMzQixJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQzthQUMvQjtZQUNELElBQUksQ0FBQyxlQUFlLEVBQUU7Z0JBRWxCLE9BQU87YUFDVjtZQUNELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FDNUMsSUFBSSxDQUFDLFdBQVcsRUFDaEIsWUFBWSxFQUNaLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxxQkFBeUIsQ0FDL0QsQ0FBQztZQUNGLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FDNUMsSUFBSSxDQUFDLFdBQVcsRUFDaEIsWUFBWSxFQUNaLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxxQkFBeUIsQ0FDOUQsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVPLGtCQUFrQjtRQUN0QixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBRXJDLE9BQU87U0FDVjtRQUNELElBQUksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUU7YUFDL0IsSUFBSSxDQUNELEdBQUcsQ0FBQyxDQUFDLEtBQW9CLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQ3ZELG9CQUFvQixFQUFFLEVBQ3RCLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQzdCO2FBQ0EsU0FBUyxDQUFDLENBQUMsV0FBb0IsRUFBRSxFQUFFO1lBQ2hDLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDcEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUNoQztZQUNELElBQUksQ0FBQyxXQUFXLEVBQUU7Z0JBRWQsT0FBTzthQUNWO1lBQ0QsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBRXJCLE9BQU87YUFDVjtZQUNELElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQztZQUNsQixJQUFJLGVBQXVCLENBQUM7WUFFNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUMsS0FBa0IsRUFBRSxFQUFFO2dCQUNyRCx3REFBd0Q7Z0JBQ3hELHNFQUFzRTtnQkFDdEUsdUNBQXVDO2dCQUN2QyxJQUFJLEtBQUssQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixFQUFFO29CQUNyRCxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3JDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7b0JBQzFCLGVBQWUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7b0JBQ3JELElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsY0FBYyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2lCQUNwRTtZQUNMLENBQUMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxLQUFrQixFQUFFLEVBQUU7Z0JBQzdELG1EQUFtRDtnQkFDbkQscURBQXFEO2dCQUNyRCw4Q0FBOEM7Z0JBRTlDLDREQUE0RDtnQkFDNUQseUNBQXlDO2dCQUN6QyxJQUFJLGVBQWUsRUFBRTtvQkFDakIsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNyQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDeEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO29CQUNoRCxTQUFTLEdBQUcsTUFBTSxDQUFDO2lCQUN0QjtZQUNMLENBQUMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsQ0FBQyxLQUFrQixFQUFFLEVBQUU7Z0JBQzdELElBQUksZUFBZSxFQUFFO29CQUNqQixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3BDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsY0FBYyxFQUFFLGVBQWUsQ0FBQyxDQUFDO29CQUMxRSxlQUFlLEdBQUcsSUFBSSxDQUFDO2lCQUMxQjtZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRU8sb0JBQW9CO1FBQ3hCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFFckMsT0FBTztTQUNWO1FBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsRUFBRTthQUMvQixJQUFJLENBQ0QsTUFBTSxDQUFDLENBQUMsS0FBb0IsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyx5QkFBeUIsQ0FBQyxFQUN4RSxXQUFXLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQyxFQUN4QyxTQUFTLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUM3QjthQUNBLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDWixJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVPLGlCQUFpQjtRQUNyQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBRXJDLE9BQU87U0FDVjtRQUNELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FDeEMsSUFBSSxDQUFDLFdBQVcsRUFDaEIsU0FBUyxFQUNULENBQUMsS0FBb0IsRUFBRSxFQUFFO1lBQ3JCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDcEMsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ3ZDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDeEI7aUJBQU0sSUFBSSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzVDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDeEI7UUFDTCxDQUFDLENBQ0osQ0FBQztJQUNOLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssb0JBQW9CO1FBQ3hCLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUU7WUFDakYsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7O1lBdFJKLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsaUJBQWlCO2dCQUMzQix5cUJBQStDO2dCQUUvQyxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtnQkFDL0MsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUk7O2FBQ3RDOzs7WUFUUSxlQUFlO1lBUnFCLFVBQVU7WUFBMEMsU0FBUztZQVNqRyxxQkFBcUI7WUFxQ21CLE1BQU0sdUJBQTlDLE1BQU0sU0FBQyxXQUFXOzs7eUJBdkJ0QixTQUFTLFNBQUMsWUFBWSxFQUFFLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEluamVjdCwgT25EZXN0cm95LCBPbkluaXQsIFBMQVRGT1JNX0lELCBSZW5kZXJlcjIsIFRlbXBsYXRlUmVmLCBWaWV3Q2hpbGQsIFZpZXdFbmNhcHN1bGF0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmcm9tRXZlbnQsIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwVG8sIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQXV0b3BsYXlTdXNwZW5kZXIgfSBmcm9tICcuLi9tb2RlbHMvYXV0b3BsYXktc3VzcGVuZGVyJztcbmltcG9ydCB7IENhcm91c2VsU2xpZGUgfSBmcm9tICcuLi9tb2RlbHMvY2Fyb3VzZWwtc2xpZGUnO1xuaW1wb3J0IHsgQ2Fyb3VzZWxTbGlkZUNvbnRleHQgfSBmcm9tICcuLi9tb2RlbHMvY2Fyb3VzZWwtc2xpZGUtY29udGV4dCc7XG5pbXBvcnQgeyBDYXJvdXNlbFN0YXRlIH0gZnJvbSAnLi4vbW9kZWxzL2Nhcm91c2VsLXN0YXRlJztcbmltcG9ydCB7IENhcm91c2VsU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2UvY2Fyb3VzZWwuc2VydmljZSc7XG5pbXBvcnQgeyBIYW1tZXJQcm92aWRlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlL2hhbW1lci1wcm92aWRlci5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY2Fyb3VzZWwtZW5naW5lJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2Nhcm91c2VsLWVuZ2luZS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2Nhcm91c2VsLWVuZ2luZS5jb21wb25lbnQuc2NzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZSxcbn0pXG4vKipcbiAqIENvbnRhaW5zIGxpc3RlbmVycyBhbmQgb3RoZXIgRE9NIGNvbnRyb2xsZXJzXG4gKi9cbmV4cG9ydCBjbGFzcyBDYXJvdXNlbEVuZ2luZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICAgIEBWaWV3Q2hpbGQoJ2dhbGxlcnlSZWYnLCB7c3RhdGljOiB0cnVlfSkgZ2FsbGVyeVJlZjogRWxlbWVudFJlZjtcbiAgICBwdWJsaWMgcmVhZG9ubHkgdHJhbnNmb3JtVmFsdWUkID0gdGhpcy50cmFuc2Zvcm1WYWx1ZUNoYW5nZXMoKTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgc2xpZGVXaWR0aCQgPSB0aGlzLnNsaWRlV2lkdGhDaGFuZ2VzKCk7XG4gICAgcHVibGljIHJlYWRvbmx5IHRlbXBsYXRlJCA9IHRoaXMudGVtcGxhdGVDaGFuZ2VzKCk7XG4gICAgcHVibGljIHJlYWRvbmx5IHNsaWRlcyQgPSB0aGlzLnNsaWRlc0NoYW5nZXMoKTtcbiAgICBwdWJsaWMgZm9jdXNlZCA9IGZhbHNlO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveWVkJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gICAgcHJpdmF0ZSBtb3VzZUVudGVyRGVzdHJ1Y3RvcjogKCkgPT4gdm9pZDtcbiAgICBwcml2YXRlIG1vdXNlTGVhdmVEZXN0cnVjdG9yOiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUga2V5Ym9hcmRMaXN0ZW5lcjogKCkgPT4gdm9pZDtcbiAgICBwcml2YXRlIGNvbnRhaW5lclNjcm9sbExpc3RlbmVyOiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgaGFtbWVyTWFuYWdlcjogSGFtbWVyTWFuYWdlcjtcblxuICAgIHByaXZhdGUgZ2V0IGh0bWxFbGVtZW50KCk6IEhUTUxFbGVtZW50IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGNhcm91c2VsOiBDYXJvdXNlbFNlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZixcbiAgICAgICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgICAgICBwcml2YXRlIGhhbW1lcjogSGFtbWVyUHJvdmlkZXJTZXJ2aWNlLFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGJhbi10eXBlc1xuICAgICAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IE9iamVjdCxcbiAgICApIHtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5saXN0ZW5Ub0F1dG9wbGF5KCk7XG4gICAgICAgIHRoaXMubGlzdGVuVG9EcmFnRXZlbnRzKCk7XG4gICAgICAgIHRoaXMubGlzdGVuVG9SZXNpemVFdmVudHMoKTtcbiAgICAgICAgdGhpcy5saXN0ZW5Ub0tleUV2ZW50cygpO1xuICAgICAgICB0aGlzLmxpc3RlblRvU2Nyb2xsRXZlbnRzKCk7XG4gICAgICAgIHRoaXMuY2Fyb3VzZWwuc2V0Q29udGFpbmVycyh0aGlzLmh0bWxFbGVtZW50LCB0aGlzLmdhbGxlcnlSZWYubmF0aXZlRWxlbWVudCk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuZGVzdHJveU1vdXNlTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuZGVzdHJveUhhbW1lcigpO1xuICAgICAgICB0aGlzLmRlc3Ryb3lLZXlib2FyZExpc3RlbmVycygpO1xuICAgICAgICB0aGlzLmRlc3Ryb3lFbGVtZW50U2Nyb2xsTGlzdGVuZXIoKTtcbiAgICAgICAgdGhpcy5kZXN0cm95ZWQkLm5leHQoKTtcbiAgICAgICAgdGhpcy5kZXN0cm95ZWQkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgdHJhY2tCeUZuKGluZGV4OiBudW1iZXIsIGl0ZW06IENhcm91c2VsU2xpZGUpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gaXRlbS5pZDtcbiAgICB9XG5cbiAgICBjb250ZXh0T2Yoc2xpZGU6IENhcm91c2VsU2xpZGUpOiBDYXJvdXNlbFNsaWRlQ29udGV4dCB7XG4gICAgICAgIHJldHVybiBuZXcgQ2Fyb3VzZWxTbGlkZUNvbnRleHQoXG4gICAgICAgICAgICBzbGlkZS5vcHRpb25zLml0ZW0sXG4gICAgICAgICAgICBzbGlkZS5pdGVtSW5kZXgsXG4gICAgICAgICAgICBzbGlkZS5vcHRpb25zLmlzQWN0aXZlLFxuICAgICAgICAgICAgc2xpZGUub3B0aW9ucy5pblZpZXdwb3J0LFxuICAgICAgICApO1xuICAgIH1cblxuICAgIGZvY3VzSW4oKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZm9jdXNlZCA9IHRydWU7XG4gICAgICAgIHRoaXMuY2Fyb3VzZWwuZGlzYWJsZUF1dG9wbGF5KEF1dG9wbGF5U3VzcGVuZGVyLkZPQ1VTKTtcbiAgICB9XG5cbiAgICBmb2N1c091dCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5mb2N1c2VkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY2Fyb3VzZWwuZW5hYmxlQXV0b3BsYXkoQXV0b3BsYXlTdXNwZW5kZXIuRk9DVVMpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVzdHJveU1vdXNlTGlzdGVuZXJzKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5tb3VzZUVudGVyRGVzdHJ1Y3Rvcikge1xuICAgICAgICAgICAgdGhpcy5tb3VzZUVudGVyRGVzdHJ1Y3RvcigpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm1vdXNlTGVhdmVEZXN0cnVjdG9yKSB7XG4gICAgICAgICAgICB0aGlzLm1vdXNlTGVhdmVEZXN0cnVjdG9yKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRlc3Ryb3lIYW1tZXIoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmhhbW1lck1hbmFnZXIpIHtcbiAgICAgICAgICAgIHRoaXMuaGFtbWVyTWFuYWdlci5kZXN0cm95KCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRlc3Ryb3lLZXlib2FyZExpc3RlbmVycygpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMua2V5Ym9hcmRMaXN0ZW5lcikge1xuICAgICAgICAgICAgdGhpcy5rZXlib2FyZExpc3RlbmVyKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRlc3Ryb3lFbGVtZW50U2Nyb2xsTGlzdGVuZXIoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmNvbnRhaW5lclNjcm9sbExpc3RlbmVyKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lclNjcm9sbExpc3RlbmVyKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHRyYW5zZm9ybVZhbHVlQ2hhbmdlcygpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jYXJvdXNlbC5jYXJvdXNlbFN0YXRlQ2hhbmdlcygpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHN0YXRlOiBDYXJvdXNlbFN0YXRlKSA9PiBgdHJhbnNsYXRlWCgke3N0YXRlLm9mZnNldH0ke3N0YXRlLmNvbmZpZy53aWR0aE1vZGV9KWApLFxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNsaWRlV2lkdGhDaGFuZ2VzKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhcm91c2VsLmNhcm91c2VsU3RhdGVDaGFuZ2VzKClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoc3RhdGU6IENhcm91c2VsU3RhdGUpID0+IGAke3N0YXRlLmNvbmZpZy5zbGlkZVdpZHRofSR7c3RhdGUuY29uZmlnLndpZHRoTW9kZX1gKSxcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzbGlkZXNDaGFuZ2VzKCk6IE9ic2VydmFibGU8Q2Fyb3VzZWxTbGlkZVtdPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhcm91c2VsLmNhcm91c2VsU3RhdGVDaGFuZ2VzKClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoc3RhdGU6IENhcm91c2VsU3RhdGUpID0+IHN0YXRlLnNsaWRlcyksXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgdGVtcGxhdGVDaGFuZ2VzKCk6IE9ic2VydmFibGU8VGVtcGxhdGVSZWY8YW55Pj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jYXJvdXNlbC5jYXJvdXNlbFN0YXRlQ2hhbmdlcygpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHN0YXRlOiBDYXJvdXNlbFN0YXRlKSA9PiBzdGF0ZS50ZW1wbGF0ZSksXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgbGlzdGVuVG9BdXRvcGxheSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG5cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNhcm91c2VsLmNhcm91c2VsU3RhdGVDaGFuZ2VzKClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoc3RhdGU6IENhcm91c2VsU3RhdGUpID0+IHN0YXRlLmNvbmZpZy5hdXRvcGxheUVuYWJsZWQpLFxuICAgICAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChhdXRvcGxheUVuYWJsZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5tb3VzZUVudGVyRGVzdHJ1Y3Rvcikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1vdXNlRW50ZXJEZXN0cnVjdG9yKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vdXNlTGVhdmVEZXN0cnVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubW91c2VMZWF2ZURlc3RydWN0b3IoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFhdXRvcGxheUVuYWJsZWQpIHtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMubW91c2VFbnRlckRlc3RydWN0b3IgPSB0aGlzLnJlbmRlcmVyLmxpc3RlbihcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5odG1sRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgJ21vdXNlZW50ZXInLFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB0aGlzLmNhcm91c2VsLmRpc2FibGVBdXRvcGxheShBdXRvcGxheVN1c3BlbmRlci5NT1VTRSksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB0aGlzLm1vdXNlTGVhdmVEZXN0cnVjdG9yID0gdGhpcy5yZW5kZXJlci5saXN0ZW4oXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaHRtbEVsZW1lbnQsXG4gICAgICAgICAgICAgICAgICAgICdtb3VzZWxlYXZlJyxcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4gdGhpcy5jYXJvdXNlbC5lbmFibGVBdXRvcGxheShBdXRvcGxheVN1c3BlbmRlci5NT1VTRSksXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgbGlzdGVuVG9EcmFnRXZlbnRzKCk6IHZvaWQge1xuICAgICAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2Fyb3VzZWwuY2Fyb3VzZWxTdGF0ZUNoYW5nZXMoKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChzdGF0ZTogQ2Fyb3VzZWxTdGF0ZSkgPT4gc3RhdGUuY29uZmlnLmRyYWdFbmFibGVkKSxcbiAgICAgICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCQpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoZHJhZ0VuYWJsZWQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5oYW1tZXJNYW5hZ2VyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaGFtbWVyTWFuYWdlci5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghZHJhZ0VuYWJsZWQpIHtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuaGFtbWVyTWFuYWdlciA9IHRoaXMuaGFtbWVyLm1hbmFnZXJGb3IodGhpcy5odG1sRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmhhbW1lck1hbmFnZXIpIHtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxldCBsYXN0RGVsdGEgPSAwO1xuICAgICAgICAgICAgICAgIGxldCBsYXN0VG91Y2hBY3Rpb246IHN0cmluZztcblxuICAgICAgICAgICAgICAgIHRoaXMuaGFtbWVyTWFuYWdlci5vbigncGFuc3RhcnQnLCAoZXZlbnQ6IEhhbW1lcklucHV0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIENoZWNraW5nIHdoZXRoZXIgcGFuIHN0YXJ0ZWQgd2l0aCBob3Jpem9udGFsIGdlc3R1cmUsXG4gICAgICAgICAgICAgICAgICAgIC8vIHdlIHNob3VsZCBibG9jayBhbGwgc2Nyb2xsIGF0dGVtcHRzIGR1cmluZyBjdXJyZW50IHBhbiBzZXNzaW9uIHRoZW5cbiAgICAgICAgICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1iaXR3aXNlXG4gICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5vZmZzZXREaXJlY3Rpb24gJiBIYW1tZXIuRElSRUNUSU9OX0hPUklaT05UQUwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3REZWx0YSA9IE1hdGgucm91bmQoZXZlbnQuZGVsdGFYKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2Fyb3VzZWwuZHJhZ1N0YXJ0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0VG91Y2hBY3Rpb24gPSB0aGlzLmh0bWxFbGVtZW50LnN0eWxlLnRvdWNoQWN0aW9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmh0bWxFbGVtZW50LCAndG91Y2gtYWN0aW9uJywgJ25vbmUnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5oYW1tZXJNYW5hZ2VyLm9uKCdwYW5yaWdodCBwYW5sZWZ0JywgKGV2ZW50OiBIYW1tZXJJbnB1dCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyBXZSBzaG91bGQgbm90IHRyZWF0IHZlcnRpY2FsIHBhbnMgYXMgaG9yaXpvbnRhbC5cbiAgICAgICAgICAgICAgICAgICAgLy8gQmUgYWR2aWNlZCB0aGF0IHBhbiByaWdodC9sZWZ0IGV2ZW50cyBzdGlsbCBjb3VudHNcbiAgICAgICAgICAgICAgICAgICAgLy8gdmVydGljYWwgcGFucyBhcyBsZWdpdGltYXRlIGhvcml6b250YWwgcGFuLlxuXG4gICAgICAgICAgICAgICAgICAgIC8vIE5leHQgY2hlY2sgY2xhcmlmaWVzIHRoYXQgaW5pdGlhbCBnZXN0dXJlIHdhcyBob3Jpem9udGFsLFxuICAgICAgICAgICAgICAgICAgICAvLyBvdGhlcndpc2UgdGhpcyB2YXJpYWJsZSB3b3VsZCBiZSBmYWxzeVxuICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFRvdWNoQWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB4ID0gTWF0aC5yb3VuZChldmVudC5jZW50ZXIueCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBkZWx0YVggPSBNYXRoLnJvdW5kKGV2ZW50LmRlbHRhWCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhcm91c2VsLmRyYWcoeCwgeCArIChkZWx0YVggLSBsYXN0RGVsdGEpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3REZWx0YSA9IGRlbHRhWDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5oYW1tZXJNYW5hZ2VyLm9uKCdwYW5lbmQgcGFuY2FuY2VsJywgKGV2ZW50OiBIYW1tZXJJbnB1dCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFRvdWNoQWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNhcm91c2VsLmRyYWdFbmQoZXZlbnQuZGVsdGFYKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUodGhpcy5odG1sRWxlbWVudCwgJ3RvdWNoLWFjdGlvbicsIGxhc3RUb3VjaEFjdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0VG91Y2hBY3Rpb24gPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxpc3RlblRvUmVzaXplRXZlbnRzKCk6IHZvaWQge1xuICAgICAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2Fyb3VzZWwuY2Fyb3VzZWxTdGF0ZUNoYW5nZXMoKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgZmlsdGVyKChzdGF0ZTogQ2Fyb3VzZWxTdGF0ZSkgPT4gc3RhdGUuY29uZmlnLnNob3VsZFJlY2FsY3VsYXRlT25SZXNpemUpLFxuICAgICAgICAgICAgICAgIHN3aXRjaE1hcFRvKGZyb21FdmVudCh3aW5kb3csICdyZXNpemUnKSksXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNhcm91c2VsLnJlY2FsY3VsYXRlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGxpc3RlblRvS2V5RXZlbnRzKCk6IHZvaWQge1xuICAgICAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMua2V5Ym9hcmRMaXN0ZW5lciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKFxuICAgICAgICAgICAgdGhpcy5odG1sRWxlbWVudCxcbiAgICAgICAgICAgICdrZXlkb3duJyxcbiAgICAgICAgICAgIChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGV2ZW50LmtleS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgIGlmIChbJ2Fycm93cmlnaHQnLCAncmlnaHQnXS5pbmNsdWRlcyhrZXkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2Fyb3VzZWwubmV4dCgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoWydhcnJvd2xlZnQnLCAnbGVmdCddLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXJvdXNlbC5wcmV2KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEhvcml6b250YWwgc2Nyb2xsIG1pZ2h0IGFjY2lkZW50YWx5IGhhcHBlbiBvbiBwYXJlbnQgY29udGFpbmVyXG4gICAgICogd2hlbiBwcmVzc2luZyBhcnJvdyBidXR0b25zIHRvbyBmYXN0LiBXZSBzaG91bGQgcmV0dXJuXG4gICAgICogY29udGFpbmVyIHRvIGluaXRpYWwgcG9zaXRpb24gd2hlbiB0aGF0IGhhcHBlbnMuXG4gICAgICovXG4gICAgcHJpdmF0ZSBsaXN0ZW5Ub1Njcm9sbEV2ZW50cygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jb250YWluZXJTY3JvbGxMaXN0ZW5lciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuaHRtbEVsZW1lbnQsICdzY3JvbGwnLCAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmh0bWxFbGVtZW50LnNjcm9sbFRvKDAsIDApO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=