import { isPlatformBrowser } from '@angular/common';
import { ChangeDetectionStrategy, Component, ElementRef, Inject, PLATFORM_ID, Renderer2, ViewChild, ViewEncapsulation } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { distinctUntilChanged, filter, map, switchMapTo, takeUntil } from 'rxjs/operators';
import { CarouselSlideContext } from '../models/carousel-slide-context';
import { CarouselService } from '../service/carousel.service';
import { HammerProviderService } from '../service/hammer-provider.service';
/**
 * Contains listeners and other DOM controllers
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../service/carousel.service';
import * as ɵngcc2 from '../service/hammer-provider.service';
import * as ɵngcc3 from '@angular/cdk/a11y';
import * as ɵngcc4 from '@angular/common';
import * as ɵngcc5 from '../directives/untabbable.directive';

const _c0 = ["galleryRef"];
function CarouselEngineComponent_li_4_ng_container_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainer(0);
} }
function CarouselEngineComponent_li_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "li", 3);
    ɵngcc0.ɵɵpipe(1, "async");
    ɵngcc0.ɵɵtemplate(2, CarouselEngineComponent_li_4_ng_container_2_Template, 1, 0, "ng-container", 4);
    ɵngcc0.ɵɵpipe(3, "async");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const slide_r3 = ctx.$implicit;
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    const _r1 = ɵngcc0.ɵɵreference(2);
    ɵngcc0.ɵɵstyleProp("width", ɵngcc0.ɵɵpipeBind1(1, 7, ctx_r2.slideWidth$));
    ɵngcc0.ɵɵproperty("untabbable", !slide_r3.options.isActive)("untabbableFocusTrapRef", _r1)("untabbableFocused", ctx_r2.focused);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngTemplateOutlet", ɵngcc0.ɵɵpipeBind1(3, 9, ctx_r2.template$))("ngTemplateOutletContext", ctx_r2.contextOf(slide_r3));
} }
export class CarouselEngineComponent {
    constructor(carousel, elementRef, renderer, hammer, 
    // tslint:disable-next-line: ban-types
    platformId) {
        this.carousel = carousel;
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.hammer = hammer;
        this.platformId = platformId;
        this.transformValue$ = this.transformValueChanges();
        this.slideWidth$ = this.slideWidthChanges();
        this.template$ = this.templateChanges();
        this.slides$ = this.slidesChanges();
        this.focused = false;
        this.destroyed$ = new Subject();
    }
    get htmlElement() {
        return this.elementRef.nativeElement;
    }
    ngOnInit() {
        this.listenToAutoplay();
        this.listenToDragEvents();
        this.listenToResizeEvents();
        this.listenToKeyEvents();
        this.listenToScrollEvents();
        this.carousel.setContainers(this.htmlElement, this.galleryRef.nativeElement);
    }
    ngOnDestroy() {
        this.destroyMouseListeners();
        this.destroyHammer();
        this.destroyKeyboardListeners();
        this.destroyElementScrollListener();
        this.destroyed$.next();
        this.destroyed$.complete();
    }
    trackByFn(index, item) {
        return item.id;
    }
    contextOf(slide) {
        return new CarouselSlideContext(slide.options.item, slide.itemIndex, slide.options.isActive, slide.options.inViewport);
    }
    focusIn() {
        this.focused = true;
        this.carousel.disableAutoplay("focus" /* FOCUS */);
    }
    focusOut() {
        this.focused = false;
        this.carousel.enableAutoplay("focus" /* FOCUS */);
    }
    destroyMouseListeners() {
        if (this.mouseEnterDestructor) {
            this.mouseEnterDestructor();
        }
        if (this.mouseLeaveDestructor) {
            this.mouseLeaveDestructor();
        }
    }
    destroyHammer() {
        if (this.hammerManager) {
            this.hammerManager.destroy();
        }
    }
    destroyKeyboardListeners() {
        if (this.keyboardListener) {
            this.keyboardListener();
        }
    }
    destroyElementScrollListener() {
        if (this.containerScrollListener) {
            this.containerScrollListener();
        }
    }
    transformValueChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => `translateX(${state.offset}${state.config.widthMode})`));
    }
    slideWidthChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => `${state.config.slideWidth}${state.config.widthMode}`));
    }
    slidesChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => state.slides));
    }
    templateChanges() {
        return this.carousel.carouselStateChanges()
            .pipe(map((state) => state.template));
    }
    listenToAutoplay() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.carousel.carouselStateChanges()
            .pipe(map((state) => state.config.autoplayEnabled), distinctUntilChanged(), takeUntil(this.destroyed$))
            .subscribe((autoplayEnabled) => {
            if (this.mouseEnterDestructor) {
                this.mouseEnterDestructor();
            }
            if (this.mouseLeaveDestructor) {
                this.mouseLeaveDestructor();
            }
            if (!autoplayEnabled) {
                return;
            }
            this.mouseEnterDestructor = this.renderer.listen(this.htmlElement, 'mouseenter', () => this.carousel.disableAutoplay("mouse" /* MOUSE */));
            this.mouseLeaveDestructor = this.renderer.listen(this.htmlElement, 'mouseleave', () => this.carousel.enableAutoplay("mouse" /* MOUSE */));
        });
    }
    listenToDragEvents() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.carousel.carouselStateChanges()
            .pipe(map((state) => state.config.dragEnabled), distinctUntilChanged(), takeUntil(this.destroyed$))
            .subscribe((dragEnabled) => {
            if (this.hammerManager) {
                this.hammerManager.destroy();
            }
            if (!dragEnabled) {
                return;
            }
            this.hammerManager = this.hammer.managerFor(this.htmlElement);
            if (!this.hammerManager) {
                return;
            }
            let lastDelta = 0;
            let lastTouchAction;
            this.hammerManager.on('panstart', (event) => {
                // Checking whether pan started with horizontal gesture,
                // we should block all scroll attempts during current pan session then
                // tslint:disable-next-line: no-bitwise
                if (event.offsetDirection & Hammer.DIRECTION_HORIZONTAL) {
                    lastDelta = Math.round(event.deltaX);
                    this.carousel.dragStart();
                    lastTouchAction = this.htmlElement.style.touchAction;
                    this.renderer.setStyle(this.htmlElement, 'touch-action', 'none');
                }
            });
            this.hammerManager.on('panright panleft', (event) => {
                // We should not treat vertical pans as horizontal.
                // Be adviced that pan right/left events still counts
                // vertical pans as legitimate horizontal pan.
                // Next check clarifies that initial gesture was horizontal,
                // otherwise this variable would be falsy
                if (lastTouchAction) {
                    const x = Math.round(event.center.x);
                    const deltaX = Math.round(event.deltaX);
                    this.carousel.drag(x, x + (deltaX - lastDelta));
                    lastDelta = deltaX;
                }
            });
            this.hammerManager.on('panend pancancel', (event) => {
                if (lastTouchAction) {
                    this.carousel.dragEnd(event.deltaX);
                    this.renderer.setStyle(this.htmlElement, 'touch-action', lastTouchAction);
                    lastTouchAction = null;
                }
            });
        });
    }
    listenToResizeEvents() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.carousel.carouselStateChanges()
            .pipe(filter((state) => state.config.shouldRecalculateOnResize), switchMapTo(fromEvent(window, 'resize')), takeUntil(this.destroyed$))
            .subscribe(() => {
            this.carousel.recalculate();
        });
    }
    listenToKeyEvents() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        this.keyboardListener = this.renderer.listen(this.htmlElement, 'keydown', (event) => {
            const key = event.key.toLowerCase();
            if (['arrowright', 'right'].includes(key)) {
                this.carousel.next();
            }
            else if (['arrowleft', 'left'].includes(key)) {
                this.carousel.prev();
            }
        });
    }
    /**
     * Horizontal scroll might accidentaly happen on parent container
     * when pressing arrow buttons too fast. We should return
     * container to initial position when that happens.
     */
    listenToScrollEvents() {
        this.containerScrollListener = this.renderer.listen(this.htmlElement, 'scroll', () => {
            this.htmlElement.scrollTo(0, 0);
        });
    }
}
CarouselEngineComponent.ɵfac = function CarouselEngineComponent_Factory(t) { return new (t || CarouselEngineComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.CarouselService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.HammerProviderService), ɵngcc0.ɵɵdirectiveInject(PLATFORM_ID)); };
CarouselEngineComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: CarouselEngineComponent, selectors: [["carousel-engine"]], viewQuery: function CarouselEngineComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵstaticViewQuery(_c0, true);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.galleryRef = _t.first);
    } }, decls: 6, vars: 9, consts: [[1, "ng-carousel-block", 3, "cdkTrapFocus", "focusin", "focusout"], ["galleryRef", "", "focusTrapRef", "cdkTrapFocus"], ["class", "ng-carousel-slide", 3, "width", "untabbable", "untabbableFocusTrapRef", "untabbableFocused", 4, "ngFor", "ngForOf", "ngForTrackBy"], [1, "ng-carousel-slide", 3, "untabbable", "untabbableFocusTrapRef", "untabbableFocused"], [4, "ngTemplateOutlet", "ngTemplateOutletContext"]], template: function CarouselEngineComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "ul", 0, 1);
        ɵngcc0.ɵɵlistener("focusin", function CarouselEngineComponent_Template_ul_focusin_0_listener() { return ctx.focusIn(); })("focusout", function CarouselEngineComponent_Template_ul_focusout_0_listener() { return ctx.focusOut(); });
        ɵngcc0.ɵɵpipe(3, "async");
        ɵngcc0.ɵɵtemplate(4, CarouselEngineComponent_li_4_Template, 4, 11, "li", 2);
        ɵngcc0.ɵɵpipe(5, "async");
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵstyleProp("transform", ɵngcc0.ɵɵpipeBind1(3, 5, ctx.transformValue$));
        ɵngcc0.ɵɵproperty("cdkTrapFocus", false);
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵproperty("ngForOf", ɵngcc0.ɵɵpipeBind1(5, 7, ctx.slides$))("ngForTrackBy", ctx.trackByFn);
    } }, directives: [ɵngcc3.CdkTrapFocus, ɵngcc4.NgForOf, ɵngcc5.FocusBlockDirective, ɵngcc4.NgTemplateOutlet], pipes: [ɵngcc4.AsyncPipe], styles: [".ng-carousel-block{display:flex;margin:0;padding:0;width:100%;will-change:transform}.ng-carousel-slide{flex:none;list-style:none}"], encapsulation: 2, changeDetection: 0 });
CarouselEngineComponent.ctorParameters = () => [
    { type: CarouselService },
    { type: ElementRef },
    { type: Renderer2 },
    { type: HammerProviderService },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] }
];
CarouselEngineComponent.propDecorators = {
    galleryRef: [{ type: ViewChild, args: ['galleryRef', { static: true },] }]
};
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(CarouselEngineComponent, [{
        type: Component,
        args: [{
                selector: 'carousel-engine',
                template: "<ul \n    #galleryRef\n    #focusTrapRef=\"cdkTrapFocus\"\n    [style.transform]=\"transformValue$ | async\"\n    [cdkTrapFocus]=\"false\"\n    (focusin)=\"focusIn()\"\n    (focusout)=\"focusOut()\"\n    class=\"ng-carousel-block\">\n    <li\n        *ngFor=\"let slide of (slides$ | async); trackBy: trackByFn;\"\n        [style.width]=\"slideWidth$ | async\"\n        [untabbable]=\"!slide.options.isActive\"\n        [untabbableFocusTrapRef]=\"focusTrapRef\"\n        [untabbableFocused]=\"focused\"\n        class=\"ng-carousel-slide\">\n        <ng-container *ngTemplateOutlet=\"(template$ | async); context: contextOf(slide);\"></ng-container>\n    </li>\n</ul>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                encapsulation: ViewEncapsulation.None,
                styles: [".ng-carousel-block{display:flex;margin:0;padding:0;width:100%;will-change:transform}.ng-carousel-slide{flex:none;list-style:none}"]
            }]
    }], function () { return [{ type: ɵngcc1.CarouselService }, { type: ɵngcc0.ElementRef }, { type: ɵngcc0.Renderer2 }, { type: ɵngcc2.HammerProviderService }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }]; }, { galleryRef: [{
            type: ViewChild,
            args: ['galleryRef', { static: true }]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2Fyb3VzZWwtZW5naW5lLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctY2Fyb3VzZWwvc3JjL2xpYi9wcml2YXRlL3ZpZXdzL2Nhcm91c2VsLWVuZ2luZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDcEQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFxQixXQUFXLEVBQUUsU0FBUyxFQUFlLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3SyxPQUFPLEVBQUUsU0FBUyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJM0YsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFFeEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzlELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBUzNFO0FBQ0E7QUFDQSxHQUFHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFDSCxNQUFNLE9BQU8sdUJBQXVCO0FBQUcsSUFtQm5DLFlBQ1ksUUFBeUIsRUFDekIsVUFBc0IsRUFDdEIsUUFBbUIsRUFDbkIsTUFBNkI7QUFDNUMsSUFBTyxzQ0FBc0M7QUFDOUMsSUFBcUMsVUFBa0I7QUFDckQsUUFOYyxhQUFRLEdBQVIsUUFBUSxDQUFpQjtBQUFDLFFBQzFCLGVBQVUsR0FBVixVQUFVLENBQVk7QUFBQyxRQUN2QixhQUFRLEdBQVIsUUFBUSxDQUFXO0FBQUMsUUFDcEIsV0FBTSxHQUFOLE1BQU0sQ0FBdUI7QUFB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LGtCQUMzQjs7Ozs7O3dGQUErQyxrQkFFL0MsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU0sa0JBQy9DLGFBQWEsRUFBRSxpQkFBaUIsQ0FBQyxJQUFJLDZLQUN0Qzs7Ozs7Ozs7Ozs7O21VQUVBO0FBQUM7QUFDQyxZQVpNLGVBQWU7QUFBSSxZQVJpQixVQUFVO0FBQUksWUFBc0MsU0FBUztBQUFJLFlBU3JHLHFCQUFxQjtBQUFJLFlBcUNlLE1BQU0sdUJBQTlDLE1BQU0sU0FBQyxXQUFXO0FBQVE7QUFBRztBQUk3Qix5QkEzQkosU0FBUyxTQUFDLFlBQVksRUFBRSxFQUFDLE1BQU0sRUFBRSxJQUFJLEVBQUM7QUFBTTs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5qZWN0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgUExBVEZPUk1fSUQsIFJlbmRlcmVyMiwgVGVtcGxhdGVSZWYsIFZpZXdDaGlsZCwgVmlld0VuY2Fwc3VsYXRpb24gfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb21FdmVudCwgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIGZpbHRlciwgbWFwLCBzd2l0Y2hNYXBUbywgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBBdXRvcGxheVN1c3BlbmRlciB9IGZyb20gJy4uL21vZGVscy9hdXRvcGxheS1zdXNwZW5kZXInO1xuaW1wb3J0IHsgQ2Fyb3VzZWxTbGlkZSB9IGZyb20gJy4uL21vZGVscy9jYXJvdXNlbC1zbGlkZSc7XG5pbXBvcnQgeyBDYXJvdXNlbFNsaWRlQ29udGV4dCB9IGZyb20gJy4uL21vZGVscy9jYXJvdXNlbC1zbGlkZS1jb250ZXh0JztcbmltcG9ydCB7IENhcm91c2VsU3RhdGUgfSBmcm9tICcuLi9tb2RlbHMvY2Fyb3VzZWwtc3RhdGUnO1xuaW1wb3J0IHsgQ2Fyb3VzZWxTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZS9jYXJvdXNlbC5zZXJ2aWNlJztcbmltcG9ydCB7IEhhbW1lclByb3ZpZGVyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2UvaGFtbWVyLXByb3ZpZGVyLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjYXJvdXNlbC1lbmdpbmUnLFxuICB0ZW1wbGF0ZVVybDogJy4vY2Fyb3VzZWwtZW5naW5lLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY2Fyb3VzZWwtZW5naW5lLmNvbXBvbmVudC5zY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxufSlcbi8qKlxuICogQ29udGFpbnMgbGlzdGVuZXJzIGFuZCBvdGhlciBET00gY29udHJvbGxlcnNcbiAqL1xuZXhwb3J0IGNsYXNzIENhcm91c2VsRW5naW5lQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gICAgQFZpZXdDaGlsZCgnZ2FsbGVyeVJlZicsIHtzdGF0aWM6IHRydWV9KSBnYWxsZXJ5UmVmOiBFbGVtZW50UmVmO1xuICAgIHB1YmxpYyByZWFkb25seSB0cmFuc2Zvcm1WYWx1ZSQgPSB0aGlzLnRyYW5zZm9ybVZhbHVlQ2hhbmdlcygpO1xuICAgIHB1YmxpYyByZWFkb25seSBzbGlkZVdpZHRoJCA9IHRoaXMuc2xpZGVXaWR0aENoYW5nZXMoKTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgdGVtcGxhdGUkID0gdGhpcy50ZW1wbGF0ZUNoYW5nZXMoKTtcbiAgICBwdWJsaWMgcmVhZG9ubHkgc2xpZGVzJCA9IHRoaXMuc2xpZGVzQ2hhbmdlcygpO1xuICAgIHB1YmxpYyBmb2N1c2VkID0gZmFsc2U7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95ZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgICBwcml2YXRlIG1vdXNlRW50ZXJEZXN0cnVjdG9yOiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgbW91c2VMZWF2ZURlc3RydWN0b3I6ICgpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSBrZXlib2FyZExpc3RlbmVyOiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgY29udGFpbmVyU2Nyb2xsTGlzdGVuZXI6ICgpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSBoYW1tZXJNYW5hZ2VyOiBIYW1tZXJNYW5hZ2VyO1xuXG4gICAgcHJpdmF0ZSBnZXQgaHRtbEVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgICAgICByZXR1cm4gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgY2Fyb3VzZWw6IENhcm91c2VsU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgICAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgICAgIHByaXZhdGUgaGFtbWVyOiBIYW1tZXJQcm92aWRlclNlcnZpY2UsXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzXG4gICAgICAgIEBJbmplY3QoUExBVEZPUk1fSUQpIHByaXZhdGUgcGxhdGZvcm1JZDogT2JqZWN0LFxuICAgICkge1xuICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICB0aGlzLmxpc3RlblRvQXV0b3BsYXkoKTtcbiAgICAgICAgdGhpcy5saXN0ZW5Ub0RyYWdFdmVudHMoKTtcbiAgICAgICAgdGhpcy5saXN0ZW5Ub1Jlc2l6ZUV2ZW50cygpO1xuICAgICAgICB0aGlzLmxpc3RlblRvS2V5RXZlbnRzKCk7XG4gICAgICAgIHRoaXMubGlzdGVuVG9TY3JvbGxFdmVudHMoKTtcbiAgICAgICAgdGhpcy5jYXJvdXNlbC5zZXRDb250YWluZXJzKHRoaXMuaHRtbEVsZW1lbnQsIHRoaXMuZ2FsbGVyeVJlZi5uYXRpdmVFbGVtZW50KTtcbiAgICB9XG5cbiAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgdGhpcy5kZXN0cm95TW91c2VMaXN0ZW5lcnMoKTtcbiAgICAgICAgdGhpcy5kZXN0cm95SGFtbWVyKCk7XG4gICAgICAgIHRoaXMuZGVzdHJveUtleWJvYXJkTGlzdGVuZXJzKCk7XG4gICAgICAgIHRoaXMuZGVzdHJveUVsZW1lbnRTY3JvbGxMaXN0ZW5lcigpO1xuICAgICAgICB0aGlzLmRlc3Ryb3llZCQubmV4dCgpO1xuICAgICAgICB0aGlzLmRlc3Ryb3llZCQuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICB0cmFja0J5Rm4oaW5kZXg6IG51bWJlciwgaXRlbTogQ2Fyb3VzZWxTbGlkZSk6IG51bWJlciB7XG4gICAgICAgIHJldHVybiBpdGVtLmlkO1xuICAgIH1cblxuICAgIGNvbnRleHRPZihzbGlkZTogQ2Fyb3VzZWxTbGlkZSk6IENhcm91c2VsU2xpZGVDb250ZXh0IHtcbiAgICAgICAgcmV0dXJuIG5ldyBDYXJvdXNlbFNsaWRlQ29udGV4dChcbiAgICAgICAgICAgIHNsaWRlLm9wdGlvbnMuaXRlbSxcbiAgICAgICAgICAgIHNsaWRlLml0ZW1JbmRleCxcbiAgICAgICAgICAgIHNsaWRlLm9wdGlvbnMuaXNBY3RpdmUsXG4gICAgICAgICAgICBzbGlkZS5vcHRpb25zLmluVmlld3BvcnQsXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgZm9jdXNJbigpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5mb2N1c2VkID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5jYXJvdXNlbC5kaXNhYmxlQXV0b3BsYXkoQXV0b3BsYXlTdXNwZW5kZXIuRk9DVVMpO1xuICAgIH1cblxuICAgIGZvY3VzT3V0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmZvY3VzZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5jYXJvdXNlbC5lbmFibGVBdXRvcGxheShBdXRvcGxheVN1c3BlbmRlci5GT0NVUyk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZXN0cm95TW91c2VMaXN0ZW5lcnMoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLm1vdXNlRW50ZXJEZXN0cnVjdG9yKSB7XG4gICAgICAgICAgICB0aGlzLm1vdXNlRW50ZXJEZXN0cnVjdG9yKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMubW91c2VMZWF2ZURlc3RydWN0b3IpIHtcbiAgICAgICAgICAgIHRoaXMubW91c2VMZWF2ZURlc3RydWN0b3IoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZGVzdHJveUhhbW1lcigpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaGFtbWVyTWFuYWdlcikge1xuICAgICAgICAgICAgdGhpcy5oYW1tZXJNYW5hZ2VyLmRlc3Ryb3koKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZGVzdHJveUtleWJvYXJkTGlzdGVuZXJzKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5rZXlib2FyZExpc3RlbmVyKSB7XG4gICAgICAgICAgICB0aGlzLmtleWJvYXJkTGlzdGVuZXIoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZGVzdHJveUVsZW1lbnRTY3JvbGxMaXN0ZW5lcigpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuY29udGFpbmVyU2Nyb2xsTGlzdGVuZXIpIHtcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyU2Nyb2xsTGlzdGVuZXIoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdHJhbnNmb3JtVmFsdWVDaGFuZ2VzKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhcm91c2VsLmNhcm91c2VsU3RhdGVDaGFuZ2VzKClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoc3RhdGU6IENhcm91c2VsU3RhdGUpID0+IGB0cmFuc2xhdGVYKCR7c3RhdGUub2Zmc2V0fSR7c3RhdGUuY29uZmlnLndpZHRoTW9kZX0pYCksXG4gICAgICAgICAgICApO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2xpZGVXaWR0aENoYW5nZXMoKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2Fyb3VzZWwuY2Fyb3VzZWxTdGF0ZUNoYW5nZXMoKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChzdGF0ZTogQ2Fyb3VzZWxTdGF0ZSkgPT4gYCR7c3RhdGUuY29uZmlnLnNsaWRlV2lkdGh9JHtzdGF0ZS5jb25maWcud2lkdGhNb2RlfWApLFxuICAgICAgICAgICAgKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNsaWRlc0NoYW5nZXMoKTogT2JzZXJ2YWJsZTxDYXJvdXNlbFNsaWRlW10+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2Fyb3VzZWwuY2Fyb3VzZWxTdGF0ZUNoYW5nZXMoKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChzdGF0ZTogQ2Fyb3VzZWxTdGF0ZSkgPT4gc3RhdGUuc2xpZGVzKSxcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0ZW1wbGF0ZUNoYW5nZXMoKTogT2JzZXJ2YWJsZTxUZW1wbGF0ZVJlZjxhbnk+PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNhcm91c2VsLmNhcm91c2VsU3RhdGVDaGFuZ2VzKClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIG1hcCgoc3RhdGU6IENhcm91c2VsU3RhdGUpID0+IHN0YXRlLnRlbXBsYXRlKSxcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsaXN0ZW5Ub0F1dG9wbGF5KCk6IHZvaWQge1xuICAgICAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcblxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY2Fyb3VzZWwuY2Fyb3VzZWxTdGF0ZUNoYW5nZXMoKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChzdGF0ZTogQ2Fyb3VzZWxTdGF0ZSkgPT4gc3RhdGUuY29uZmlnLmF1dG9wbGF5RW5hYmxlZCksXG4gICAgICAgICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKGF1dG9wbGF5RW5hYmxlZDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLm1vdXNlRW50ZXJEZXN0cnVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubW91c2VFbnRlckRlc3RydWN0b3IoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubW91c2VMZWF2ZURlc3RydWN0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tb3VzZUxlYXZlRGVzdHJ1Y3RvcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWF1dG9wbGF5RW5hYmxlZCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5tb3VzZUVudGVyRGVzdHJ1Y3RvciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmh0bWxFbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICAnbW91c2VlbnRlcicsXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHRoaXMuY2Fyb3VzZWwuZGlzYWJsZUF1dG9wbGF5KEF1dG9wbGF5U3VzcGVuZGVyLk1PVVNFKSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHRoaXMubW91c2VMZWF2ZURlc3RydWN0b3IgPSB0aGlzLnJlbmRlcmVyLmxpc3RlbihcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5odG1sRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgJ21vdXNlbGVhdmUnLFxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB0aGlzLmNhcm91c2VsLmVuYWJsZUF1dG9wbGF5KEF1dG9wbGF5U3VzcGVuZGVyLk1PVVNFKSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBsaXN0ZW5Ub0RyYWdFdmVudHMoKTogdm9pZCB7XG4gICAgICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jYXJvdXNlbC5jYXJvdXNlbFN0YXRlQ2hhbmdlcygpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHN0YXRlOiBDYXJvdXNlbFN0YXRlKSA9PiBzdGF0ZS5jb25maWcuZHJhZ0VuYWJsZWQpLFxuICAgICAgICAgICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCksXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChkcmFnRW5hYmxlZDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhbW1lck1hbmFnZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW1tZXJNYW5hZ2VyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFkcmFnRW5hYmxlZCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5oYW1tZXJNYW5hZ2VyID0gdGhpcy5oYW1tZXIubWFuYWdlckZvcih0aGlzLmh0bWxFbGVtZW50KTtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaGFtbWVyTWFuYWdlcikge1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGV0IGxhc3REZWx0YSA9IDA7XG4gICAgICAgICAgICAgICAgbGV0IGxhc3RUb3VjaEFjdGlvbjogc3RyaW5nO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5oYW1tZXJNYW5hZ2VyLm9uKCdwYW5zdGFydCcsIChldmVudDogSGFtbWVySW5wdXQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2tpbmcgd2hldGhlciBwYW4gc3RhcnRlZCB3aXRoIGhvcml6b250YWwgZ2VzdHVyZSxcbiAgICAgICAgICAgICAgICAgICAgLy8gd2Ugc2hvdWxkIGJsb2NrIGFsbCBzY3JvbGwgYXR0ZW1wdHMgZHVyaW5nIGN1cnJlbnQgcGFuIHNlc3Npb24gdGhlblxuICAgICAgICAgICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWJpdHdpc2VcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50Lm9mZnNldERpcmVjdGlvbiAmIEhhbW1lci5ESVJFQ1RJT05fSE9SSVpPTlRBTCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdERlbHRhID0gTWF0aC5yb3VuZChldmVudC5kZWx0YVgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXJvdXNlbC5kcmFnU3RhcnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RUb3VjaEFjdGlvbiA9IHRoaXMuaHRtbEVsZW1lbnQuc3R5bGUudG91Y2hBY3Rpb247XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKHRoaXMuaHRtbEVsZW1lbnQsICd0b3VjaC1hY3Rpb24nLCAnbm9uZScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmhhbW1lck1hbmFnZXIub24oJ3BhbnJpZ2h0IHBhbmxlZnQnLCAoZXZlbnQ6IEhhbW1lcklucHV0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFdlIHNob3VsZCBub3QgdHJlYXQgdmVydGljYWwgcGFucyBhcyBob3Jpem9udGFsLlxuICAgICAgICAgICAgICAgICAgICAvLyBCZSBhZHZpY2VkIHRoYXQgcGFuIHJpZ2h0L2xlZnQgZXZlbnRzIHN0aWxsIGNvdW50c1xuICAgICAgICAgICAgICAgICAgICAvLyB2ZXJ0aWNhbCBwYW5zIGFzIGxlZ2l0aW1hdGUgaG9yaXpvbnRhbCBwYW4uXG5cbiAgICAgICAgICAgICAgICAgICAgLy8gTmV4dCBjaGVjayBjbGFyaWZpZXMgdGhhdCBpbml0aWFsIGdlc3R1cmUgd2FzIGhvcml6b250YWwsXG4gICAgICAgICAgICAgICAgICAgIC8vIG90aGVyd2lzZSB0aGlzIHZhcmlhYmxlIHdvdWxkIGJlIGZhbHN5XG4gICAgICAgICAgICAgICAgICAgIGlmIChsYXN0VG91Y2hBY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHggPSBNYXRoLnJvdW5kKGV2ZW50LmNlbnRlci54KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlbHRhWCA9IE1hdGgucm91bmQoZXZlbnQuZGVsdGFYKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2Fyb3VzZWwuZHJhZyh4LCB4ICsgKGRlbHRhWCAtIGxhc3REZWx0YSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdERlbHRhID0gZGVsdGFYO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmhhbW1lck1hbmFnZXIub24oJ3BhbmVuZCBwYW5jYW5jZWwnLCAoZXZlbnQ6IEhhbW1lcklucHV0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsYXN0VG91Y2hBY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2Fyb3VzZWwuZHJhZ0VuZChldmVudC5kZWx0YVgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRTdHlsZSh0aGlzLmh0bWxFbGVtZW50LCAndG91Y2gtYWN0aW9uJywgbGFzdFRvdWNoQWN0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RUb3VjaEFjdGlvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgbGlzdGVuVG9SZXNpemVFdmVudHMoKTogdm9pZCB7XG4gICAgICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jYXJvdXNlbC5jYXJvdXNlbFN0YXRlQ2hhbmdlcygpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBmaWx0ZXIoKHN0YXRlOiBDYXJvdXNlbFN0YXRlKSA9PiBzdGF0ZS5jb25maWcuc2hvdWxkUmVjYWxjdWxhdGVPblJlc2l6ZSksXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwVG8oZnJvbUV2ZW50KHdpbmRvdywgJ3Jlc2l6ZScpKSxcbiAgICAgICAgICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQkKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY2Fyb3VzZWwucmVjYWxjdWxhdGUoKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgbGlzdGVuVG9LZXlFdmVudHMoKTogdm9pZCB7XG4gICAgICAgIGlmICghaXNQbGF0Zm9ybUJyb3dzZXIodGhpcy5wbGF0Zm9ybUlkKSkge1xuXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5rZXlib2FyZExpc3RlbmVyID0gdGhpcy5yZW5kZXJlci5saXN0ZW4oXG4gICAgICAgICAgICB0aGlzLmh0bWxFbGVtZW50LFxuICAgICAgICAgICAgJ2tleWRvd24nLFxuICAgICAgICAgICAgKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gZXZlbnQua2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgaWYgKFsnYXJyb3dyaWdodCcsICdyaWdodCddLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYXJvdXNlbC5uZXh0KCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChbJ2Fycm93bGVmdCcsICdsZWZ0J10uaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhcm91c2VsLnByZXYoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSG9yaXpvbnRhbCBzY3JvbGwgbWlnaHQgYWNjaWRlbnRhbHkgaGFwcGVuIG9uIHBhcmVudCBjb250YWluZXJcbiAgICAgKiB3aGVuIHByZXNzaW5nIGFycm93IGJ1dHRvbnMgdG9vIGZhc3QuIFdlIHNob3VsZCByZXR1cm5cbiAgICAgKiBjb250YWluZXIgdG8gaW5pdGlhbCBwb3NpdGlvbiB3aGVuIHRoYXQgaGFwcGVucy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGxpc3RlblRvU2Nyb2xsRXZlbnRzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmNvbnRhaW5lclNjcm9sbExpc3RlbmVyID0gdGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy5odG1sRWxlbWVudCwgJ3Njcm9sbCcsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaHRtbEVsZW1lbnQuc2Nyb2xsVG8oMCwgMCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==